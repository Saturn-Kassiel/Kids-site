// =============================================
// ะะะจะ โ ะะพะดัะปั ัะตััะธัะพะฒะฐะฝะธั (testing.js)
// =============================================

const TESTING_TASKS = {
    cognitive: {
        counting: {
            '3-4': { max: 5, rounds: 3 },
            '4-5': { max: 10, rounds: 3 },
            '5-6': { max: 15, rounds: 3 },
            '6-7': { max: 10, rounds: 3, arithmetic: true }
        },
        colors: {
            '3-4': { items: [
                { name: 'ะบัะฐัะฝัะน', css: '#ef4444' },
                { name: 'ัะธะฝะธะน', css: '#3b82f6' },
                { name: 'ะถัะปััะน', css: '#eab308' },
                { name: 'ะทะตะปัะฝัะน', css: '#22c55e' }
            ], rounds: 4 },
            '4-5': { items: [
                { name: 'ะบัะฐัะฝัะน', css: '#ef4444' },
                { name: 'ัะธะฝะธะน', css: '#3b82f6' },
                { name: 'ะถัะปััะน', css: '#eab308' },
                { name: 'ะทะตะปัะฝัะน', css: '#22c55e' },
                { name: 'ะพัะฐะฝะถะตะฒัะน', css: '#f97316' },
                { name: 'ัะธะพะปะตัะพะฒัะน', css: '#a855f7' }
            ], rounds: 5 },
            '5-6': { items: [
                { name: 'ะบัะฐัะฝัะน', css: '#ef4444' },
                { name: 'ัะธะฝะธะน', css: '#3b82f6' },
                { name: 'ะถัะปััะน', css: '#eab308' },
                { name: 'ะทะตะปัะฝัะน', css: '#22c55e' },
                { name: 'ะพัะฐะฝะถะตะฒัะน', css: '#f97316' },
                { name: 'ัะธะพะปะตัะพะฒัะน', css: '#a855f7' },
                { name: 'ัะพะทะพะฒัะน', css: '#ec4899' },
                { name: 'ะณะพะปัะฑะพะน', css: '#38bdf8' }
            ], rounds: 5 },
            '6-7': null // ะฒะผะตััะต ัะพ ััััะพะผ
        },
        shapes: {
            '3-4': { shapes: ['ะบััะณ','ะบะฒะฐะดัะฐั','ััะตัะณะพะปัะฝะธะบ'], rounds: 3 },
            '4-5': { shapes: ['ะบััะณ','ะบะฒะฐะดัะฐั','ััะตัะณะพะปัะฝะธะบ','ะฟััะผะพัะณะพะปัะฝะธะบ','ะพะฒะฐะป'], rounds: 4 },
            '5-6': { shapes: ['ะบััะณ','ะบะฒะฐะดัะฐั','ััะตัะณะพะปัะฝะธะบ','ะฟััะผะพัะณะพะปัะฝะธะบ','ะพะฒะฐะป','ัะพะผะฑ','ะทะฒะตะทะดะฐ'], rounds: 4 },
            '6-7': { shapes: ['ะบััะณ','ะบะฒะฐะดัะฐั','ััะตัะณะพะปัะฝะธะบ','ะฟััะผะพัะณะพะปัะฝะธะบ','ัะพะผะฑ','ะทะฒะตะทะดะฐ','ััะฐะฟะตัะธั'], rounds: 4 }
        },
        oddOneOut: {
            '3-4': { sets: [
                { items: ['๐','๐','๐','๐'], odd: 3, hint: 'ะขัะธ โ ะตะดะฐ, ะฐ ะพะดะฝะพ โ ะฝะตั' },
                { items: ['๐ฑ','๐ถ','๐','๐ช'], odd: 3, hint: 'ะขัะธ โ ะถะธะฒะพัะฝัะต' },
                { items: ['๐','๐','๐งข','๐ณ'], odd: 3, hint: 'ะขัะธ โ ะพะดะตะถะดะฐ' },
                { items: ['๐','๐','๐','๐'], odd: 3, hint: 'ะขัะธ โ ััะฐะฝัะฟะพัั' },
                { items: ['๐ฅ','๐ด','๐ฅฃ','๐'], odd: 3, hint: 'ะขัะธ โ ะฟะพััะดะฐ' },
                { items: ['๐ธ','๐ป','๐น','โฝ'], odd: 3, hint: 'ะขัะธ โ ัะฒะตัั' },
                { items: ['๐๏ธ','๐ช','๐๏ธ','๐'], odd: 3, hint: 'ะขัะธ โ ะผะตะฑะตะปั' },
                { items: ['๐','๐ข','๐ฅพ','๐ฑ'], odd: 3, hint: 'ะขัะธ โ ะพะฑัะฒั' },
                { items: ['โ๏ธ','๐','๐๏ธ','๐ฐ'], odd: 3, hint: 'ะขัะธ โ ะดะปั ัะธัะพะฒะฐะฝะธั' },
                { items: ['๐ค','๐ฆ','๐ฆ','๐ธ'], odd: 3, hint: 'ะขัะธ โ ะฟัะธัั' }
            ]},
            '4-5': { sets: [
                { items: ['๐','๐','๐','๐'], odd: 3, hint: 'ะขัะธ โ ััะฐะฝัะฟะพัั' },
                { items: ['๐ธ','๐ป','๐น','๐'], odd: 3, hint: 'ะขัะธ โ ัะฒะตัั' },
                { items: ['๐ง','๐ฅ','๐ฆ','๐'], odd: 3, hint: 'ะขัะธ โ ะผะพะปะพัะฝะพะต' },
                { items: ['โ๏ธ','๐','๐','โฝ'], odd: 3, hint: 'ะขัะธ โ ะดะปั ัััะฑั' },
                { items: ['๐','๐','๐ญ','๐ธ'], odd: 3, hint: 'ะขัะธ โ ะตะดะฐ' },
                { items: ['๐ป','๐ฏ','๐ฆ','๐ต'], odd: 3, hint: 'ะขัะธ โ ะดะธะบะธะต ะทะฒะตัะธ' },
                { items: ['โ๏ธ','๐งฅ','๐งค','๐บ'], odd: 3, hint: 'ะขัะธ โ ะพั ัะพะปะพะดะฐ' },
                { items: ['๐น','๐ธ','๐ฅ','๐ง'], odd: 3, hint: 'ะขัะธ โ ะธะฝััััะผะตะฝัั ะผัะทัะบะฐะปัะฝัะต' },
                { items: ['๐','โฝ','๐พ','๐จ'], odd: 3, hint: 'ะขัะธ โ ะผััะธ' },
                { items: ['๐','๐ซ','๐','๐ฅ'], odd: 3, hint: 'ะขัะธ โ ัะณะพะดั' }
            ]},
            '5-6': { sets: [
                { items: ['๐','๐','๐ฒ','โ๏ธ'], odd: 3, hint: 'ะขัะธ ะตะทะดัั, ะพะดะธะฝ ะปะตัะฐะตั' },
                { items: ['๐','๐ฅ','๐','๐'], odd: 1, hint: 'ะขัะธ โ ัััะบัั' },
                { items: ['๐','๐','๐','๐๏ธ'], odd: 3, hint: 'ะขัะธ โ ะฝะฐ ะณะพะปะพะฒะต' },
                { items: ['โ๏ธ','โญ','๐','๐ง๏ธ'], odd: 3, hint: 'ะขัะธ ัะฒะตััั' },
                { items: ['๐ฆ','๐ฆ','๐ฆ','๐'], odd: 3, hint: 'ะขัะธ ะปะตัะฐัั' },
                { items: ['๐ง','โ๏ธ','โ','๐ฅ'], odd: 3, hint: 'ะขัะธ โ ัะพะปะพะดะฝะพะต' },
                { items: ['๐','๐','๐','๐'], odd: 3, hint: 'ะขัะธ โ ะบะฝะธะณะธ' },
                { items: ['๐','๐ฃ','โต','๐'], odd: 3, hint: 'ะขัะธ โ ะฝะฐ ะฒะพะดะต' },
                { items: ['๐','๐ง','๐ฉ','๐ฅฆ'], odd: 3, hint: 'ะขัะธ โ ัะปะฐะดะบะพะต/ะฒะบััะฝะพะต' },
                { items: ['๐บ','๐ป','๐ท','๐จ'], odd: 3, hint: 'ะขัะธ โ ะผัะท. ะธะฝััััะผะตะฝัั' }
            ]},
            '6-7': { sets: [
                { items: ['โฌ','โฌ','๐บ','๐ฆ'], odd: 2, hint: 'ะะดะฝะฐ ัะธะณััะฐ โ ััะตัะณะพะปัะฝะธะบ, ะพััะฐะปัะฝัะต ัะตััััััะณะพะปัะฝะธะบะธ' },
                { items: ['๐ก','๐ต','๐ข','๐ฅ'], odd: 3, hint: 'ะขัะธ ะบััะณะปัะต, ะพะดะธะฝ ะบะฒะฐะดัะฐั' },
                { items: ['2๏ธโฃ','4๏ธโฃ','6๏ธโฃ','7๏ธโฃ'], odd: 3, hint: 'ะขัะธ ัััะฝัั' },
                { items: ['ะ','ะ','ะฃ','ะ'], odd: 3, hint: 'ะขัะธ ะณะปะฐัะฝัะต' },
                { items: ['๐ฑ','๐ถ','๐ญ','๐'], odd: 3, hint: 'ะขัะธ ะดะพะผะฐัะฝะธั' },
                { items: ['๐ท๐บ','๐บ๐ธ','๐ซ๐ท','๐ต'], odd: 3, hint: 'ะขัะธ โ ัะปะฐะณะธ' },
                { items: ['โ','โ','โ๏ธ','๐ค'], odd: 3, hint: 'ะขัะธ โ ะทะฝะฐะบะธ ะผะฐัะตะผะฐัะธะบะธ' },
                { items: ['๐','๐','โญ','๐'], odd: 3, hint: 'ะขัะธ โ ะฒ ะบะพัะผะพัะต' },
                { items: ['1๏ธโฃ','3๏ธโฃ','5๏ธโฃ','8๏ธโฃ'], odd: 3, hint: 'ะขัะธ ะฝะตัััะฝัั' },
                { items: ['๐','๐ฆ','๐','๐ธ'], odd: 3, hint: 'ะขัะธ โ ะฝะฐัะตะบะพะผัะต' }
            ]}
        },
        sequence: {
            '3-4': { sets: [
                { items: ['๐ฅ','๐ฃ','๐'], correct: [0,1,2], label: 'ะฏะนัะพ โ ะฆัะฟะปัะฝะพะบ โ ะััะธัะฐ' },
                { items: ['๐ฑ','๐ฟ','๐ณ'], correct: [0,1,2], label: 'ะะพััะพะบ โ ะััั โ ะะตัะตะฒะพ' },
                { items: ['๐ด','๐','๐ฎ'], correct: [0,1,2], label: 'ะกะพะฝ โ ะฃััะพ โ ะะณัะฐ' },
                { items: ['๐ง','๐ง','โ๏ธ'], correct: [0,1,2], label: 'ะัะด โ ะะพะดะฐ โ ะะฑะปะฐะบะพ' },
                { items: ['๐ถ','๐ง','๐ฆ'], correct: [0,1,2], label: 'ะะฐะปัั โ ะะตะฑัะฝะพะบ โ ะะฐะปััะธะบ' },
                { items: ['๐ง๏ธ','๐','โ๏ธ'], correct: [0,1,2], label: 'ะะพะถะดั โ ะะฐะดัะณะฐ โ ะกะพะปะฝัะต' },
                { items: ['๐ฅ','๐ง','๐ง'], correct: [0,1,2], label: 'ะะพะปะพะบะพ โ ะะฐัะปะพ โ ะกัั' },
                { items: ['๐ฐ','๐ฑ','๐ป'], correct: [0,1,2], label: 'ะกะตะผะตัะบะพ โ ะะพััะพะบ โ ะะพะดัะพะปะฝัั' },
                { items: ['๐','๐ซง','๐ฆ'], correct: [0,1,2], label: 'ะััะตะฝะธัะฐ โ ะะพะบะพะฝ โ ะะฐะฑะพัะบะฐ' },
                { items: ['๐','๐ฅช','๐'], correct: [0,1,2], label: 'ะฅะปะตะฑ โ ะััะตัะฑัะพะด โ ะััะฐะตะผ' }
            ]},
            '4-5': { sets: [
                { items: ['๐ด','๐ฅฃ','๐','๐'], correct: [0,1,2,3], label: 'ะฃััะพ โ ะะฐะฒััะฐะบ โ ะะฐะฝััะธั โ ะัะพะณัะปะบะฐ' },
                { items: ['๐ง๏ธ','๐ง','๐','โ๏ธ'], correct: [0,1,2,3], label: 'ะะพะถะดั โ ะะฐะฟะปั โ ะะตะบะฐ โ ะกะพะปะฝัะต' },
                { items: ['๐ฅ','๐ณ','๐ฝ๏ธ','๐'], correct: [0,1,2,3], label: 'ะฏะนัะพ โ ะะพัะพะฒะธะผ โ ะขะฐัะตะปะบะฐ โ ะััะฐะตะผ' },
                { items: ['๐ฐ','๐ฑ','๐ฟ','๐ณ'], correct: [0,1,2,3], label: 'ะกะตะผั โ ะะพััะพะบ โ ะััั โ ะะตัะตะฒะพ' },
                { items: ['๐งฑ','๐๏ธ','๐','๐จโ๐ฉโ๐ง'], correct: [0,1,2,3], label: 'ะะธัะฟะธัะธ โ ะกััะพะนะบะฐ โ ะะพะผ โ ะกะตะผัั' },
                { items: ['๐','โ๏ธ','๐งถ','๐งฃ'], correct: [0,1,2,3], label: 'ะะฒะตัะบะฐ โ ะกััะธะถัะผ โ ะะธัะบะธ โ ะจะฐัั' },
                { items: ['๐','โ๏ธ','๐จ','๐ผ๏ธ'], correct: [0,1,2,3], label: 'ะะธััะตะผ โ ะััะตะทะฐะตะผ โ ะัะฐัะธะผ โ ะะฐััะธะฝะฐ' },
                { items: ['๐พ','๐ญ','๐','๐ฅช'], correct: [0,1,2,3], label: 'ะัะตะฝะธัะฐ โ ะัะบะฐ โ ะฅะปะตะฑ โ ะััะตัะฑัะพะด' },
                { items: ['๐','๐ฅ','๐ณ','๐ฒ'], correct: [0,1,2,3], label: 'ะะฐะณะฐะทะธะฝ โ ะัะพะดัะบัั โ ะะพัะพะฒะธะผ โ ะกัะฟ' },
                { items: ['๐','๐','๐','๐'], correct: [0,1,2,3], label: 'ะะปะบะฐ โ ะะตะด ะะพัะพะท โ ะะพะดะฐัะพะบ โ ะัะฐะทะดะฝะธะบ' }
            ]},
            '5-6': { sets: [
                { items: ['๐ฑ','๐ฟ','๐ธ','๐','๐ฅง'], correct: [0,1,2,3,4], label: 'ะกะตะผะตัะบะพ โ ะะพััะพะบ โ ะฆะฒะตัะพะบ โ ะฏะฑะปะพะบะพ โ ะะธัะพะณ' },
                { items: ['๐','โ๏ธ','๐จ','๐ผ๏ธ','๐'], correct: [0,1,2,3,4], label: 'ะะธััะตะผ โ ะััะตะทะฐะตะผ โ ะัะฐัะธะผ โ ะะตัะฐะตะผ โ ะะพัะพะฒะพ!' },
                { items: ['๐','๐ซง','๐ฆ','๐ธ','๐ฏ'], correct: [0,1,2,3,4], label: 'ะััะตะฝะธัะฐ โ ะะพะบะพะฝ โ ะะฐะฑะพัะบะฐ โ ะฆะฒะตัะพะบ โ ะัะด' },
                { items: ['โ๏ธ','๐ง๏ธ','๐ง','๐','๐'], correct: [0,1,2,3,4], label: 'ะะฑะปะฐะบะพ โ ะะพะถะดั โ ะะฐะฟะปั โ ะะตะบะฐ โ ะัะฑะฐ' },
                { items: ['๐พ','๐ญ','๐','๐ง','๐ฅช'], correct: [0,1,2,3,4], label: 'ะัะตะฝะธัะฐ โ ะะตะปัะฝะธัะฐ โ ะฅะปะตะฑ โ ะะฐัะปะพ โ ะััะตัะฑัะพะด' },
                { items: ['๐ชต','๐ฅ','โ','๐','๐ด'], correct: [0,1,2,3,4], label: 'ะัะพะฒะฐ โ ะะณะพะฝั โ ะงะฐะน โ ะะฝะธะณะฐ โ ะกะพะฝ' },
                { items: ['๐ฌ','๐ฟ','๐บ','๐','๐ค'], correct: [0,1,2,3,4], label: 'ะะธะฝะพ โ ะะพะฟะบะพัะฝ โ ะกะผะพััะธะผ โ ะกะผะตัะผัั โ ะกะฟะธะผ' },
                { items: ['๐','๐ฅ','๐ณ','๐ฅ','๐'], correct: [0,1,2,3,4], label: 'ะััะธัะฐ โ ะฏะนัะพ โ ะะฐัะธะผ โ ะกะฐะปะฐั โ ะะบััะฝะพ' },
                { items: ['๐๏ธ','๐ง๏ธ','๐๏ธ','๐','๐'], correct: [0,1,2,3,4], label: 'ะะพัะฐ โ ะะพะถะดั โ ะะทะตัะพ โ ะะพัะต โ ะะธั' },
                { items: ['๐ถ','๐ง','๐ฆ','๐จ','๐ด'], correct: [0,1,2,3,4], label: 'ะะฐะปัั โ ะะตะฑัะฝะพะบ โ ะะฐะปััะธะบ โ ะัะถัะธะฝะฐ โ ะะตะดััะบะฐ' }
            ]},
            '6-7': { sets: [
                { items: ['๐','๐ถ','๐ซ','๐','๐','๐'], correct: [0,1,2,3,4,5], label: 'ะะพะผ โ ะะดัะผ โ ะจะบะพะปะฐ โ ะฃััะฑะฐ โ ะะตะถะธะผ โ ะะพะผะพะน' },
                { items: ['๐','๐','๐','๐','๐','๐'], correct: [0,1,2,3,4,5], label: 'ะคะฐะทั ะัะฝั' },
                { items: ['๐ง๏ธ','โ๏ธ','โ','โ๏ธ','๐ง','๐ฑ'], correct: [0,1,2,3,4,5], label: 'ะะพะถะดั โ ะกะฝะตะณ โ ะกะฝะตะณะพะฒะธะบ โ ะะตัะฝะฐ โ ะขะฐะตั โ ะะพััะพะบ' },
                { items: ['๐ฅ','๐ฃ','๐ฅ','๐','๐ฅ','๐ณ'], correct: [0,1,2,3,4,5], label: 'ะฏะนัะพ โ ะัะปัะฟะธะปัั โ ะััะพั โ ะััะธัะฐ โ ะฏะนัะพ โ ะะผะปะตั' },
                { items: ['๐','โ๏ธ','๐','๐ฎ','โ๏ธ','๐'], correct: [0,1,2,3,4,5], label: 'ะงะธัะฐะตะผ โ ะะธัะตะผ โ ะะธััะผะพ โ ะะพััะฐ โ ะะพััะฐะฒะบะฐ โ ะะฐะดะพััั' },
                { items: ['๐','๐','๐','๐จโ๐','๐ณ๏ธ','๐'], correct: [0,1,2,3,4,5], label: 'ะะตะผะปั โ ะะฐะบะตัะฐ โ ะัะฝะฐ โ ะะพัะผะพะฝะฐะฒั โ ะคะปะฐะณ โ ะะพะผะพะน' },
                { items: ['๐','โ๏ธ','๐จ','โ๏ธ','๐ง๏ธ','๐'], correct: [0,1,2,3,4,5], label: 'ะะพัะต โ ะกะพะปะฝัะต โ ะะตัะตั โ ะะฑะปะฐะบะพ โ ะะพะถะดั โ ะะฐะดัะณะฐ' },
                { items: ['๐งฑ','๐๏ธ','๐','๐จ','๐๏ธ','๐จโ๐ฉโ๐งโ๐ฆ'], correct: [0,1,2,3,4,5], label: 'ะะธัะฟะธัะธ โ ะกััะพะนะบะฐ โ ะะพะผ โ ะะตะผะพะฝั โ ะะตะฑะตะปั โ ะกะตะผัั' },
                { items: ['๐พ','๐ญ','๐','๐ง','๐ฅช','๐'], correct: [0,1,2,3,4,5], label: 'ะะพะปะต โ ะะฐะฒะพะด โ ะฅะปะตะฑ โ ะกัั โ ะััะตัะฑัะพะด โ ะ ัะบะพะปั' },
                { items: ['๐ก','๐','๐ง','๐งช','๐','โญ'], correct: [0,1,2,3,4,5], label: 'ะะดะตั โ ะะปะฐะฝ โ ะะฐะฑะพัะฐ โ ะัะฟััะฐะฝะธะต โ ะะฐะฟััะบ โ ะฃัะฟะตั' }
            ]}
        }
    },
    speech: {
        vocabulary: {
            '3-4': { sets: [
                { img: '๐ฑ', correct: 'ะะพัะบะฐ', options: ['ะะพัะบะฐ','ะจะฐะฟะบะฐ','ะะพะถะบะฐ'] },
                { img: '๐', correct: 'ะะพะผ', options: ['ะะพะผ','ะกะพะผ','ะะพะผ'] },
                { img: 'โ๏ธ', correct: 'ะกะพะปะฝัะต', options: ['ะกะพะปะฝัะต','ะะพะปััะพ','ะกะตัะดัะต'] },
                { img: '๐', correct: 'ะะฐัะธะฝะฐ', options: ['ะะฐัะธะฝะฐ','ะะฐะปะธะฝะฐ','ะะฐััะธะฝะฐ'] },
                { img: '๐ณ', correct: 'ะะตัะตะฒะพ', options: ['ะะตัะตะฒะพ','ะะพะปะตะฝะพ','ะกัะตะบะปะพ'] },
                { img: '๐', correct: 'ะกะพะฑะฐะบะฐ', options: ['ะกะพะฑะฐะบะฐ','ะัะฑะฐัะบะฐ','ะกะพัะพะบะฐ'] },
                { img: '๐', correct: 'ะฏะฑะปะพะบะพ', options: ['ะฏะฑะปะพะบะพ','ะะฑะปะฐะบะพ','ะะพะปะพะบะพ'] },
                { img: '๐', correct: 'ะัะฑะฐ', options: ['ะัะฑะฐ','ะัะธะฑั','ะจัะฑะฐ'] },
                { img: '๐', correct: 'ะัะฝะฐ', options: ['ะัะฝะฐ','ะะพะถะบะฐ','ะะฐะฟะฐ'] },
                { img: '๐ฆ', correct: 'ะัะธัะฐ', options: ['ะัะธัะฐ','ะะธััะฐ','ะฃะปะธัะฐ'] }
            ]},
            '4-5': { sets: [
                { img: '๐๐๐', correct: 'ะคััะบัั', options: ['ะคััะบัั','ะะฒะพัะธ','ะฏะณะพะดั'] },
                { img: '๐ฑ๐ถ๐ญ', correct: 'ะะธะฒะพัะฝัะต', options: ['ะะธะฒะพัะฝัะต','ะะณัััะบะธ','ะะฐัะตะบะพะผัะต'] },
                { img: '๐๐๐', correct: 'ะขัะฐะฝัะฟะพัั', options: ['ะขัะฐะฝัะฟะพัั','ะะตะฑะตะปั','ะะพััะดะฐ'] },
                { img: '๐๐๐งข', correct: 'ะะดะตะถะดะฐ', options: ['ะะดะตะถะดะฐ','ะะดะฐ','ะขะตัะฝะธะบะฐ'] },
                { img: '๐ฅ๐ฝ๏ธ๐ฅฃ', correct: 'ะะพััะดะฐ', options: ['ะะพััะดะฐ','ะะดะตะถะดะฐ','ะะตะฑะตะปั'] },
                { img: '๐ฅ๐ฅ๐', correct: 'ะะฒะพัะธ', options: ['ะะฒะพัะธ','ะคััะบัั','ะฆะฒะตัั'] },
                { img: '๐๏ธ๐ช๐๏ธ', correct: 'ะะตะฑะตะปั', options: ['ะะตะฑะตะปั','ะะดะตะถะดะฐ','ะะพััะดะฐ'] },
                { img: '๐๐ฆ๐', correct: 'ะะฐัะตะบะพะผัะต', options: ['ะะฐัะตะบะพะผัะต','ะัะธัั','ะัะฑั'] },
                { img: '๐๐ข๐ฅพ', correct: 'ะะฑัะฒั', options: ['ะะฑัะฒั','ะะดะตะถะดะฐ','ะะณัััะบะธ'] },
                { img: '๐น๐ธ๐ฅ', correct: 'ะะฝััััะผะตะฝัั', options: ['ะะฝััััะผะตะฝัั','ะะณัััะบะธ','ะขะตัะฝะธะบะฐ'] }
            ]},
            '5-6': { sets: [
                { img: 'ะะพะปััะพะน โ ?', correct: 'ะะฐะปะตะฝัะบะธะน', options: ['ะะฐะปะตะฝัะบะธะน','ะะปะธะฝะฝัะน','ะัะฐัะฝัะน'], type: 'antonym' },
                { img: 'ะะพัััะธะน โ ?', correct: 'ะฅะพะปะพะดะฝัะน', options: ['ะฅะพะปะพะดะฝัะน','ะะพะบััะน','ะัััััะน'], type: 'antonym' },
                { img: 'ะะตััะปัะน โ ?', correct: 'ะััััะฝัะน', options: ['ะััััะฝัะน','ะััะพะบะธะน','ะขะธัะธะน'], type: 'antonym' },
                { img: 'ะัััััะน โ ?', correct: 'ะะตะดะปะตะฝะฝัะน', options: ['ะะตะดะปะตะฝะฝัะน','ะัะณะบะธะน','ะกะธะปัะฝัะน'], type: 'antonym' },
                { img: 'ะััะพะบะพ โ ?', correct: 'ะะธะทะบะพ', options: ['ะะธะทะบะพ','ะะฐะปะตะบะพ','ะขะธัะพ'], type: 'antonym' },
                { img: 'ะขัะถัะปัะน โ ?', correct: 'ะัะณะบะธะน', options: ['ะัะณะบะธะน','ะัะณะบะธะน','ะกััะพะน'], type: 'antonym' },
                { img: 'ะจะธัะพะบะธะน โ ?', correct: 'ะฃะทะบะธะน', options: ['ะฃะทะบะธะน','ะขะพะฝะบะธะน','ะะตะปะบะธะน'], type: 'antonym' },
                { img: 'ะะพะฑััะน โ ?', correct: 'ะะปะพะน', options: ['ะะปะพะน','ะขะธัะธะน','ะกะผะตัะฝะพะน'], type: 'antonym' },
                { img: 'ะะฐะปะตะบะพ โ ?', correct: 'ะะปะธะทะบะพ', options: ['ะะปะธะทะบะพ','ะัะดะพะผ','ะขะธัะพ'], type: 'antonym' },
                { img: 'ะกัะฐััะน โ ?', correct: 'ะะพะปะพะดะพะน', options: ['ะะพะปะพะดะพะน','ะะฐะปะตะฝัะบะธะน','ะะพะฒัะน'], type: 'antonym' }
            ]},
            '6-7': { sets: [
                { img: 'โ๏ธ', correct: 'ะะฐัะธัะฐ ะพั ะดะพะถะดั', options: ['ะะฐัะธัะฐ ะพั ะดะพะถะดั','ะะดะฐ','ะขัะฐะฝัะฟะพัั'], type: 'define' },
                { img: '๐', correct: 'ะฅัะฐะฝะธั ะทะฝะฐะฝะธั', options: ['ะฅัะฐะฝะธั ะทะฝะฐะฝะธั','ะะณัััะบะฐ','ะะฝััััะผะตะฝั'], type: 'define' },
                { img: '๐ฅ', correct: 'ะะตัะฐั ะปัะดะตะน', options: ['ะะตัะฐั ะปัะดะตะน','ะะพัะพะฒัั ะตะดั','ะฃัะฐั ะดะตัะตะน'], type: 'define' },
                { img: '๐จโ๐ซ', correct: 'ะฃัะธั ะดะตัะตะน', options: ['ะฃัะธั ะดะตัะตะน','ะะตัะธั ะปัะดะตะน','ะกััะพะธั ะดะพะผะฐ'], type: 'define' },
                { img: '๐งโ๐ณ', correct: 'ะะพัะพะฒะธั ะตะดั', options: ['ะะพัะพะฒะธั ะตะดั','ะะพะดะธั ะผะฐัะธะฝั','ะะธััะตั'], type: 'define' },
                { img: '๐', correct: 'ะขััะธั ะฟะพะถะฐัั', options: ['ะขััะธั ะฟะพะถะฐัั','ะะตัะธั ะปัะดะตะน','ะะพะทะธั ะณััะทั'], type: 'define' },
                { img: 'โ๏ธ', correct: 'ะะตัะฐะตั ะฟะพ ะฝะตะฑั', options: ['ะะตัะฐะตั ะฟะพ ะฝะตะฑั','ะะปะฐะฒะฐะตั ะฒ ะฒะพะดะต','ะะทะดะธั ะฟะพ ะดะพัะพะณะต'], type: 'define' },
                { img: '๐ฌ', correct: 'ะฃะฒะตะปะธัะธะฒะฐะตั ะผะตะปะบะพะต', options: ['ะฃะฒะตะปะธัะธะฒะฐะตั ะผะตะปะบะพะต','ะะฐัะธั ะตะดั','ะะณัะฐะตั ะผัะทัะบั'], type: 'define' },
                { img: '๐งญ', correct: 'ะะพะบะฐะทัะฒะฐะตั ะฝะฐะฟัะฐะฒะปะตะฝะธะต', options: ['ะะพะบะฐะทัะฒะฐะตั ะฝะฐะฟัะฐะฒะปะตะฝะธะต','ะะทะผะตััะตั ะฒัะตะผั','ะกัะธัะฐะตั ะดะตะฝัะณะธ'], type: 'define' },
                { img: '๐ก๏ธ', correct: 'ะะทะผะตััะตั ัะตะผะฟะตัะฐัััั', options: ['ะะทะผะตััะตั ัะตะผะฟะตัะฐัััั','ะะพะบะฐะทัะฒะฐะตั ะฒัะตะผั','ะกัะธัะฐะตั ัะฐะณะธ'], type: 'define' }
            ]}
        },
        grammar: {
            '5-6': { sets: [
                { q: 'ะะฝะพะณะพ ะดะตัะตะฒัะตะฒ ะธะปะธ ะดะตัะตะฒะพะฒ?', correct: 'ะดะตัะตะฒัะตะฒ', options: ['ะดะตัะตะฒัะตะฒ','ะดะตัะตะฒะพะฒ'] },
                { q: 'ะะตะฒะพัะบะฐ ะฟัะธัะปะฐ ะธะปะธ ะฟัะธััะป?', correct: 'ะฟัะธัะปะฐ', options: ['ะฟัะธัะปะฐ','ะฟัะธััะป'] },
                { q: 'ะะพั ัะธะดะธั ... ัััะปะต', correct: 'ะฝะฐ', options: ['ะฝะฐ','ะฒ','ะฟะพะด'] },
                { q: 'ะะฝะพะณะพ ะบะฐัะฐะฝะดะฐัะตะน ะธะปะธ ะบะฐัะฐะฝะดะฐัะพะฒ?', correct: 'ะบะฐัะฐะฝะดะฐัะตะน', options: ['ะบะฐัะฐะฝะดะฐัะตะน','ะบะฐัะฐะฝะดะฐัะพะฒ'] },
                { q: 'ะััะธะบ ะปะตะถะธั ... ััะพะปะพะผ', correct: 'ะฟะพะด', options: ['ะฟะพะด','ะฝะฐ','ะฒ'] },
                { q: 'ะะฝะพะณะพ ััะตะน ะธะปะธ ััะพะฒ?', correct: 'ััะตะน', options: ['ััะตะน','ััะพะฒ'] },
                { q: 'ะะพัะบะฐ ัะฟััะณะฝัะปะฐ ... ะดะตัะตะฒะฐ', correct: 'ั', options: ['ั','ะธะท','ะพั'] },
                { q: 'ะะฐะปััะธะบ ะธะณัะฐะตั ... ะผััะพะผ', correct: 'ั', options: ['ั','ะฒ','ะฝะฐ'] },
                { q: 'ะะฝะพะณะพ ะปะพะถะตะบ ะธะปะธ ะปะพะถะบะพะฒ?', correct: 'ะปะพะถะตะบ', options: ['ะปะพะถะตะบ','ะปะพะถะบะพะฒ'] },
                { q: 'ะัะธัะฐ ัะธะดะธั ... ะฒะตัะบะต', correct: 'ะฝะฐ', options: ['ะฝะฐ','ะฒ','ะฟะพะด'] }
            ]},
            '6-7': { sets: [
                { q: 'ะะฝะพะณะพ ัััะปัะตะฒ ะธะปะธ ัััะปะพะฒ?', correct: 'ัััะปัะตะฒ', options: ['ัััะปัะตะฒ','ัััะปะพะฒ'] },
                { q: 'ะะฝะพะณะพ ะพะบะพะฝ ะธะปะธ ะพะบะฝะพะฒ?', correct: 'ะพะบะพะฝ', options: ['ะพะบะพะฝ','ะพะบะฝะพะฒ','ะพะบะฝะตะน'] },
                { q: 'ะะพะปะพะถะธ ะบะฝะธะณั ... ะฟะพะปะบั', correct: 'ะฝะฐ', options: ['ะฝะฐ','ะฒ','ะฟะพะด','ะทะฐ'] },
                { q: 'ะัะธัะฐ ะฒัะปะตัะตะปะฐ ... ะณะฝะตะทะดะฐ', correct: 'ะธะท', options: ['ะธะท','ั','ะพั','ั'] },
                { q: 'ะั ... ะฒ ะฟะฐัะบะต ะฒัะตัะฐ', correct: 'ะณัะปัะปะธ', options: ['ะณัะปัะปะธ','ะณัะปัะตะผ','ะณัะปััั'] },
                { q: 'ะะฝะพะณะพ ะฟะพะปะพัะตะฝัะตะฒ ะธะปะธ ะฟะพะปะพัะตะฝะตั?', correct: 'ะฟะพะปะพัะตะฝะตั', options: ['ะฟะพะปะพัะตะฝะตั','ะฟะพะปะพัะตะฝัะตะฒ'] },
                { q: 'ะะฝ ะฑะตะถะธั ะฑััััะตะต ะธะปะธ ะฑะพะปะตะต ะฑััััะพ?', correct: 'ะฑััััะตะต', options: ['ะฑััััะตะต','ะฑะพะปะตะต ะฑััััะพ','ะฑััััะตะน'] },
                { q: 'ะะตัะธ ะฒััะปะธ ... ัะบะพะปั', correct: 'ะธะท', options: ['ะธะท','ั','ะพั','ั'] },
                { q: 'ะะฝะพะณะพ ะฝะพัะบะพะฒ ะธะปะธ ะฝะพัะพะบ?', correct: 'ะฝะพัะบะพะฒ', options: ['ะฝะพัะบะพะฒ','ะฝะพัะพะบ'] },
                { q: 'ะะฐะปััะธะบ ... ะบัะฐัะธะฒะพ ัะธัะพะฒะฐัั', correct: 'ัะผะตะตั', options: ['ัะผะตะตั','ัะผะตะป','ัะผะตัั'] }
            ]}
        },
        // ะัะดะธะพะทะฐะฟะธัั โ ะฟะพะฒัะพัะธ ัะปะพะฒะพ (ะฟัะพะฑะปะตะผะฝัะต ะทะฒัะบะธ ะฟะพ ะฒะพะทัะฐััั)
        recordWords: {
            '3-4': {
                words: [
                    { word: 'ะัะฑะฐ', emoji: '๐', sounds: ['ั'] },
                    { word: 'ะจะฐะฟะบะฐ', emoji: '๐งข', sounds: ['ั'] },
                    { word: 'ะะธัะฐ', emoji: '๐ฆ', sounds: ['ะป','ั'] },
                    { word: 'ะงะฐัะบะฐ', emoji: 'โ', sounds: ['ั','ั'] },
                    { word: 'ะัั', emoji: 'โฝ', sounds: ['ะผ'] },
                    { word: 'ะัะบ', emoji: '๐ชฒ', sounds: ['ะถ'] },
                    { word: 'ะะฐะนะบะฐ', emoji: '๐ฐ', sounds: ['ะท'] },
                    { word: 'ะฆะฒะตัะพะบ', emoji: '๐ธ', sounds: ['ั'] },
                    { word: 'ะกะพะฑะฐะบะฐ', emoji: '๐', sounds: ['ั','ะฑ'] },
                    { word: 'ะะพัะบะฐ', emoji: '๐ฑ', sounds: ['ั'] }
                ], maxSec: 5
            },
            '4-5': {
                words: [
                    { word: 'ะะพัะพะฒะฐ', emoji: '๐', sounds: ['ั'] },
                    { word: 'ะะพะถะฝะธัั', emoji: 'โ๏ธ', sounds: ['ะถ','ั'] },
                    { word: 'ะฉััะบะฐ', emoji: '๐ชฅ', sounds: ['ั'] },
                    { word: 'ะะพะฝัะธะบ', emoji: 'โ๏ธ', sounds: ['ะท'] },
                    { word: 'ะะฐะฑะพัะบะฐ', emoji: '๐ฆ', sounds: ['ะฑ'] },
                    { word: 'ะะฐัะฐะฝะดะฐั', emoji: 'โ๏ธ', sounds: ['ั','ั'] },
                    { word: 'ะกะฐะผะพะปัั', emoji: 'โ๏ธ', sounds: ['ั','ะป'] },
                    { word: 'ะงะตัะตะฟะฐัะฐ', emoji: '๐ข', sounds: ['ั','ั'] },
                    { word: 'ะจะพะบะพะปะฐะด', emoji: '๐ซ', sounds: ['ั','ะป'] },
                    { word: 'ะัะณััะบะฐ', emoji: '๐ธ', sounds: ['ะป','ั'] }
                ], maxSec: 5
            },
            '5-6': {
                words: [
                    { word: 'ะญะบัะบะฐะฒะฐัะพั', emoji: '๐', sounds: ['ะบั','ั'] },
                    { word: 'ะะบะฒะฐัะธัะผ', emoji: '๐', sounds: ['ะบะฒ','ั'] },
                    { word: 'ะะดัะฐะฒััะฒัะนัะต', emoji: '๐', sounds: ['ะทะดั','ััะฒ'] },
                    { word: 'ะะตะปะพัะธะฟะตะด', emoji: '๐ฒ', sounds: ['ะป','ั'] },
                    { word: 'ะงะตัะตะฟะฐัะฐ', emoji: '๐ข', sounds: ['ั','ั'] },
                    { word: 'ะฅะพะปะพะดะธะปัะฝะธะบ', emoji: '๐ง', sounds: ['ั','ะป'] },
                    { word: 'ะะฐัะธะบะผะฐัะตั', emoji: '๐', sounds: ['ั','ั'] },
                    { word: 'ะกะฒะตัะพัะพั', emoji: '๐ฆ', sounds: ['ัะฒ','ั'] },
                    { word: 'ะฏัะตัะธัะฐ', emoji: '๐ฆ', sounds: ['ั','ั'] },
                    { word: 'ะขัะฐะผะฒะฐะน', emoji: '๐', sounds: ['ัั','ะผ'] }
                ], maxSec: 6
            },
            '6-7': {
                words: [
                    { word: 'ะญะปะตะบััะธัะตััะฒะพ', emoji: 'โก', sounds: ['ะบั','ั','ััะฒ'] },
                    { word: 'ะขะตะผะฟะตัะฐัััะฐ', emoji: '๐ก๏ธ', sounds: ['ะผะฟ','ั'] },
                    { word: 'ะกะบะฒะพัะตัะฝะธะบ', emoji: '๐', sounds: ['ัะบะฒ','ั'] },
                    { word: 'ะัะพััะพะบะฒะฐัะฐ', emoji: '๐ฅ', sounds: ['ัั','ะบะฒ','ั'] },
                    { word: 'ะะตะณัะปะธัะพะฒัะธะบ', emoji: '๐ฎ', sounds: ['ั','ะณ','ั'] },
                    { word: 'ะะธะฑะปะธะพัะตะบะฐัั', emoji: '๐', sounds: ['ะฑะป','ั'] },
                    { word: 'ะะพัะฐะฑะปะตะบัััะตะฝะธะต', emoji: '๐ข', sounds: ['ั','ะบั','ั'] },
                    { word: 'ะะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััั', emoji: '๐๏ธ', sounds: ['ัั','ั','ั'] },
                    { word: 'ะััะตัะตััะฒะตะฝะฝะธะบ', emoji: '๐งณ', sounds: ['ั','ััะฒ'] },
                    { word: 'ะะตะผะปะตััััะตะฝะธะต', emoji: '๐', sounds: ['ะผะป','ัั','ั'] }
                ], maxSec: 6
            }
        },
        // ะัะดะธะพะทะฐะฟะธัั โ ะพะฟะธัะธ ะบะฐััะธะฝะบั (ัะฒัะทะฝะฐั ัะตัั)
        recordDescribe: {
            '3-4': { scenes: [
                { emoji: '๐ง๐๐ณ๐', prompt: 'ะะฐะปััะธะบ ะณัะปัะตั ั ัะพะฑะฐะบะพะน ะฒ ะฟะฐัะบะต' }
            ], maxSec: 20 },
            '4-5': { scenes: [
                { emoji: '๐จโ๐ฉโ๐งโ๐ฆ๐ฝ๏ธ๐ฅ๐', prompt: 'ะกะตะผัั ะพะฑะตะดะฐะตั ะทะฐ ััะพะปะพะผ' }
            ], maxSec: 25 },
            '5-6': { scenes: [
                { emoji: '๐ง๐ง๐๏ธ๐๐', prompt: 'ะะตัะธ ะธะณัะฐัั ะฝะฐ ะฟะปัะถะต' }
            ], maxSec: 30 },
            '6-7': { scenes: [
                { emoji: '๐ซ๐๐ฉโ๐ซ๐ง๐ง', prompt: 'ะฃัะพะบ ะฒ ัะบะพะปะต' }
            ], maxSec: 30 }
        }
    },
    social: {
        emotions: {
            '3-4': { sets: [
                { scene: '๐๐๐', desc: 'ะะตะฑัะฝะพะบ ะฝะฐ ะฟัะฐะทะดะฝะธะบะต!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐ข๐งธ๐', desc: 'ะะธัะบะฐ ัะปะพะผะฐะปัั...', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐ฆ๐ฌ๐ซ', desc: 'ะะต ะดะฐะปะธ ะบะพะฝัะตัั', correct: 'ะะปะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐๐โจ', desc: 'ะะพะปััะธะป ะฟะพะดะฐัะพะบ!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั'] },
                { scene: '๐ง๏ธ๐ข๐', desc: 'ะะตะปัะทั ะณัะปััั โ ะดะพะถะดั', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐ถ๐๐', desc: 'ะฉะตะฝะพะบ ะปะธะถะตั ััะบั', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั'] },
                { scene: '๐ง๐ฆ๐คธ', desc: 'ะะพัะพะถะตะฝะพะต ะธ ะฟััะถะบะธ!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐งธ๐ซ๐ค', desc: 'ะัะพะฑัะฐะปะธ ะธะณัััะบั', correct: 'ะะปะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] },
                { scene: '๐๐ป๐จ', desc: 'ะกััะฐัะฝัะน ะทะฒัะบ ะฝะพััั', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั'] },
                { scene: '๐ฆ๐จ๐', desc: 'ะะธััะตั ัะฐะดัะณั', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั'] }
            ]},
            '4-5': { sets: [
                { scene: '๐ฉ๏ธ๐จ๐', desc: 'ะัะพะทะฐ ะทะฐ ะพะบะฝะพะผ', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐๐๐ฆ', desc: 'ะะฐัััะตะปะธ ะธ ะผะพัะพะถะตะฝะพะต!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐ซ๐ซ๐ข', desc: 'ะะต ะฑะตััั ะฒ ะธะณัั', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐งฉ๐๐', desc: 'ะกะพะฑัะฐะป ะฟะฐะทะป!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐๐ฑ๐', desc: 'ะฃะฒะธะดะตะป ะทะผะตั', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐พ๐๐', desc: 'ะัะธะณัะฐะป ัะพัะตะฒะฝะพะฒะฐะฝะธะต', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐ฆ๐ฅ๐ง', desc: 'ะขะพะปะบะฝัะปะธ ะฝะฐ ะฟะปะพัะฐะดะบะต', correct: 'ะะปะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐น๐๐ฟ', desc: 'ะฅะพะผััะพะบ ะทะฐะฑะพะปะตะป', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐ช๐คก๐', desc: 'ะะปะพัะฝ ะฒ ัะธัะบะต!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] },
                { scene: '๐บ๐ซ๐ค', desc: 'ะัะบะปััะธะปะธ ะผัะปััะธะบ', correct: 'ะะปะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั'] }
            ]},
            '5-6': { sets: [
                { scene: '๐บ๐๐ณ', desc: 'ะะฐะทะฑะธะป ะผะฐะผะธะฝั ะฒะฐะทั', correct: 'ะกััะด', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด'] },
                { scene: '๐ฉ๐๐ฎ', desc: 'ะคะพะบััะฝะธะบ ะดะพััะฐะป ะบัะพะปะธะบะฐ!', correct: 'ะฃะดะธะฒะปะตะฝะธะต', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั','ะฃะดะธะฒะปะตะฝะธะต','ะกััะด'] },
                { scene: '๐๐๐จ', desc: 'ะะพะปััะฐั ัะพะฑะฐะบะฐ ะฑะตะถะธั', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐จ๐ผ๏ธ๐', desc: 'ะะฐัะธัะพะฒะฐะป ะบัะฐัะธะฒัะน ัะธััะฝะพะบ', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต','ะกััะฐั'] },
                { scene: '๐คฅ๐ฉ๐ณ', desc: 'ะะฐะผะฐ ัะทะฝะฐะปะฐ ะฟัะพ ะพะฑะผะฐะฝ', correct: 'ะกััะด', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด'] },
                { scene: '๐๐ฆ๐ฒ', desc: 'ะะฝัััะธ ะฟะพะดะฐัะบะฐ โ ะบะพััะฝะพะบ!', correct: 'ะฃะดะธะฒะปะตะฝะธะต', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั','ะฃะดะธะฒะปะตะฝะธะต','ะกััะด'] },
                { scene: '๐ง๐๐ข', desc: 'ะััััะฝะฐั ัะบะฐะทะบะฐ', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐๐๐', desc: 'ะัะธััะป ะฟะตัะฒัะน ะฒ ะทะฐะฑะตะณะต', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต','ะกััะฐั'] },
                { scene: '๐ง๐ง๐ซ', desc: 'ะะฐะทะปะธะป ัะพะบ ะฝะฐ ัะบะฐัะตััั', correct: 'ะกััะด', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐๐๐ฒ', desc: 'ะะตัะฒัะน ัะฐะปัั ะฒ ะถะธะทะฝะธ', correct: 'ะฃะดะธะฒะปะตะฝะธะต', options: ['ะะฐะดะพััั','ะััััั','ะกััะฐั','ะฃะดะธะฒะปะตะฝะธะต','ะกััะด'] }
            ]},
            '6-7': { sets: [
                { scene: '๐๐ข๐', desc: 'ะัััะธะน ะดััะณ ัะตะทะถะฐะตั', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐ซ๐๐ฐ', desc: 'ะะตัะฒัะน ะดะตะฝั ะฒ ัะบะพะปะต', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐คฅ๐๐ณ', desc: 'ะะฑะผะฐะฝัะป, ะธ ะฒัะต ัะทะฝะฐะปะธ', correct: 'ะกััะด', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐๐๐ฒ', desc: 'ะกััะฟัะธะท ะฝะฐ ะดะตะฝั ัะพะถะดะตะฝะธั!', correct: 'ะฃะดะธะฒะปะตะฝะธะต', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐โ๐ค', desc: 'ะะพะปััะธะป ะฟะปะพััั ะพัะตะฝะบั', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐๐๏ธ๐', desc: 'ะะพะฑะตะดะฐ ะฝะฐ ะพะปะธะผะฟะธะฐะดะต!', correct: 'ะะฐะดะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐ฆ๐๐ง', desc: 'ะัะพ-ัะพ ะพะฑะธะถะฐะตั ะดััะณะฐ', correct: 'ะะปะพััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐ญ๐๐ฒ', desc: 'ะะบััั ัะฝัะป ะผะฐัะบั โ ะทะฝะฐะบะพะผัะน!', correct: 'ะฃะดะธะฒะปะตะฝะธะต', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐ฑ๐๐ข', desc: 'ะะพัะตััะป ะปัะฑะธะผัะน ัะตะปะตัะพะฝ', correct: 'ะััััั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] },
                { scene: '๐ง๐ค๐', desc: 'ะััััะฟะปะตะฝะธะต ะฟะตัะตะด ะบะปะฐััะพะผ', correct: 'ะกััะฐั', options: ['ะะฐะดะพััั','ะััััั','ะะปะพััั','ะกััะฐั','ะกััะด','ะฃะดะธะฒะปะตะฝะธะต'] }
            ]}
        },
        situations: {
            '3-4': { sets: [
                { desc: 'ะะฐะปััะธะบ ัะพัะตั ะธะณัััะบั ะดััะณะพะณะพ ัะตะฑัะฝะบะฐ', options: ['ะัะพะฑัะฐัั','ะะพะฟัะพัะธัั','ะะฐะฟะปะฐะบะฐัั'], prosocial: 1 },
                { desc: 'ะขั ััะพะฝะธะป ััะถะพะน ะบะฐัะฐะฝะดะฐั', options: ['ะฃะนัะธ','ะะพะดะฝััั ะธ ะพัะดะฐัั','ะกะฟัััะฐัั'], prosocial: 1 },
                { desc: 'ะะฐะผะฐ ะทะพะฒัั ะพะฑะตะดะฐัั', options: ['ะะต ะธะดัะธ','ะัะธะนัะธ','ะกะฟัััะฐัััั'], prosocial: 1 },
                { desc: 'ะะตะฒะพัะบะฐ ะฟะปะฐัะตั ะฝะฐ ะฟะปะพัะฐะดะบะต', options: ['ะฃะนัะธ','ะกะฟัะพัะธัั ััะพ ัะปััะธะปะพัั','ะะพัะผะตััััั'], prosocial: 1 },
                { desc: 'ะะพั ัะธะดะธั ะฝะฐ ะดะตัะตะฒะต ะธ ะผััะบะฐะตั', options: ['ะัะพัะธัั ะบะฐะผะตะฝั','ะะพะทะฒะฐัั ะฒะทัะพัะปะพะณะพ','ะะฐะฑััั'], prosocial: 1 },
                { desc: 'ะััะณ ะดะฐะป ัะตะฑะต ะบะพะฝัะตัั', options: ['ะะพะปัะฐ ะทะฐะฑัะฐัั','ะกะบะฐะทะฐัั ัะฟะฐัะธะฑะพ','ะะพะฟัะพัะธัั ะตัั'], prosocial: 1 },
                { desc: 'ะขั ัะปััะฐะนะฝะพ ัะฐะทะปะธะป ะฒะพะดั', options: ['ะฃะฑะตะถะฐัั','ะััะตัะตัั','ะกะฟัััะฐัััั'], prosocial: 1 },
                { desc: 'ะะฐะปัั ะฝะต ะผะพะถะตั ะพัะบัััั ะดะฒะตัั', options: ['ะัะพะนัะธ ะผะธะผะพ','ะะพะผะพัั ะพัะบัััั','ะะพัะผะตััััั'], prosocial: 1 },
                { desc: 'ะะพัะฐ ะปะพะถะธัััั ัะฟะฐัั', options: ['ะกะฟัััะฐัััั','ะะพะนัะธ ะฒ ะบัะพะฒะฐัั','ะัะธัะฐัั'], prosocial: 1 },
                { desc: 'ะ ะฟะตัะพัะฝะธัะต ะฝะตั ัะฒะพะฑะพะดะฝะพะน ะปะพะฟะฐัะบะธ', options: ['ะัะพะฑัะฐัั','ะะพะฟัะพัะธัั ะฟะพะดะตะปะธัััั','ะะฐะฟะปะฐะบะฐัั'], prosocial: 1 }
            ]},
            '4-5': { sets: [
                { desc: 'ะะตะฒะพัะบะฐ ัะปะพะผะฐะปะฐ ััะถัั ะธะณัััะบั', options: ['ะกะฟัััะฐัั','ะะทะฒะธะฝะธัััั','ะฃะฑะตะถะฐัั'], prosocial: 1 },
                { desc: 'ะขั ะฒะธะดะธัั, ััะพ ะผะฐะปัั ะฟะปะฐัะตั', options: ['ะัะพะนัะธ ะผะธะผะพ','ะกะฟัะพัะธัั ััะพ ัะปััะธะปะพัั','ะะพัะผะตััััั'], prosocial: 1 },
                { desc: 'ะััะณ ะฟะพะดะตะปะธะปัั ะบะพะฝัะตัะพะน', options: ['ะะฐะฑัะฐัั ะฒัะต','ะกะบะฐะทะฐัั ัะฟะฐัะธะฑะพ','ะะต ะพะฑัะฐัะฐัั ะฒะฝะธะผะฐะฝะธั'], prosocial: 1 },
                { desc: 'ะขั ะฝะฐััะป ะฝะฐ ัะปะธัะต ััะถะพะน ะผัั', options: ['ะะฐะฑัะฐัั ะดะพะผะพะน','ะะพะฟัะพะฑะพะฒะฐัั ะฝะฐะนัะธ ัะพะทัะธะฝะฐ','ะะฝััั ะดะฐะปะตะบะพ'], prosocial: 1 },
                { desc: 'ะะฐะฑััะบะฐ ะฝะตััั ััะถัะปัั ััะผะบั', options: ['ะัะพะนัะธ ะผะธะผะพ','ะัะตะดะปะพะถะธัั ะฟะพะผะพัั','ะะพัะผะพััะตัั ะธ ัะนัะธ'], prosocial: 1 },
                { desc: 'ะะฐะปััะธะบ ะฑะตะท ะฟะฐัั ะฝะฐ ะฟัะพะณัะปะบะต', options: ['ะะต ะทะฐะผะตัะฐัั','ะัะตะดะปะพะถะธัั ะธะดัะธ ะฒะผะตััะต','ะฃะฑะตะถะฐัั'], prosocial: 1 },
                { desc: 'ะขั ัะพัะตัั ัะพ ะถะต ััะพ ะธ ะดััะณ', options: ['ะะพะดัะฐัััั','ะะพะณะพะฒะพัะธัััั ะฟะพ ะพัะตัะตะดะธ','ะะฐะฟะปะฐะบะฐัั'], prosocial: 1 },
                { desc: 'ะะพัะฟะธัะฐัะตะปั ะฟัะพัะธั ัะฑัะฐัั ะธะณัััะบะธ', options: ['ะกะฟัััะฐัััั','ะะพะผะพัั ัะฑัะฐัั','ะกะบะฐะทะฐัั ะฝะตั'], prosocial: 1 },
                { desc: 'ะัะพ-ัะพ ััะพะฝะธะป ะฒะฐัะตะถะบั', options: ['ะะฐัััะฟะธัั','ะะพะดะฝััั ะธ ะฒะตัะฝััั','ะะต ะทะฐะผะตัะธัั'], prosocial: 1 },
                { desc: 'ะฉะตะฝะพะบ ะฑะพะธััั ะธ ะดัะพะถะธั', options: ['ะัะพะณะฝะฐัั','ะะพะณะปะฐะดะธัั ะธ ััะฟะพะบะพะธัั','ะฃะนัะธ'], prosocial: 1 }
            ]},
            '5-6': { sets: [
                { desc: 'ะััะณ ัะฟะฐะป ะธ ะฟะปะฐัะตั', options: ['ะะพัะผะตััััั','ะะพะผะพัั ะฒััะฐัั','ะฃะนัะธ'], prosocial: 1 },
                { desc: 'ะขั ะฝะฐััะป ััะถัั ะฒะตัั', options: ['ะะฐะฑัะฐัั ัะตะฑะต','ะะตัะฝััั ัะพะทัะธะฝั','ะัะฑัะพัะธัั'], prosocial: 1 },
                { desc: 'ะัะพ-ัะพ ะพะฑะทัะฒะฐะตััั ะฒ ัะฐะดะธะบะต', options: ['ะะฑะพะทะฒะฐัั ะฒ ะพัะฒะตั','ะกะบะฐะทะฐัั ะฒะพัะฟะธัะฐัะตะปั','ะฃะดะฐัะธัั'], prosocial: 1 },
                { desc: 'ะะพะดััะณะฐ ะณััััะธั', options: ['ะะต ะทะฐะผะตัะฐัั','ะกะฟัะพัะธัั ััะพ ัะปััะธะปะพัั','ะฃะนัะธ ะธะณัะฐัั'], prosocial: 1 },
                { desc: 'ะะฐะปััะธะบ ะฝะต ัะผะตะตั ะธะณัะฐัั ะฒ ะฒะฐัั ะธะณัั', options: ['ะัะพะณะฝะฐัั','ะะฑัััะฝะธัั ะฟัะฐะฒะธะปะฐ','ะะพัะผะตััััั'], prosocial: 1 },
                { desc: 'ะขั ะฒะธะดะธัั ััะพ ะบัะพ-ัะพ ะฒััั', options: ['ะขะพะถะต ัะพะฒัะฐัั','ะกะบะฐะทะฐัั ะฟัะฐะฒะดั','ะัะพะผะพะปัะฐัั'], prosocial: 1 },
                { desc: 'ะ ะฐะฒัะพะฑััะต ะฑะฐะฑััะบะต ะฝะตะณะดะต ัะตััั', options: ['ะัะฒะตัะฝััััั','ะฃัััะฟะธัั ะผะตััะพ','ะัะธัะฒะพัะธัััั ัะฟััะธะผ'], prosocial: 1 },
                { desc: 'ะะปะฐะดัะธะน ะฑัะฐั ะธัะฟะพััะธะป ัะธััะฝะพะบ', options: ['ะะฐะบัะธัะฐัั','ะะฑัััะฝะธัั ััะพ ะฝะตะปัะทั','ะกะปะพะผะฐัั ะตะณะพ ะฒะตัั'], prosocial: 1 },
                { desc: 'ะขั ัะปััะฐะนะฝะพ ะฝะฐัััะฟะธะป ะบะพะผั-ัะพ ะฝะฐ ะฝะพะณั', options: ['ะฃะนัะธ ะฑััััะพ','ะะทะฒะธะฝะธัััั','ะกะบะฐะทะฐัั ััะพ ะพะฝ ัะฐะผ ะฒะธะฝะพะฒะฐั'], prosocial: 1 },
                { desc: 'ะััะณ ะทะฐะฑัะป ะพะฑะตะด ะดะพะผะฐ', options: ['ะะต ะทะฐะผะตัะฐัั','ะะพะดะตะปะธัััั ัะฒะพะธะผ','ะะพัะผะตััััั'], prosocial: 1 }
            ]},
            '6-7': { sets: [
                { desc: 'ะขะตะฑั ะฝะต ะฑะตััั ะฒ ะธะณัั', options: ['ะะฑะธะดะตัััั','ะกะฟัะพัะธัั ะฟะพัะตะผั','ะะพะถะฐะปะพะฒะฐัััั'], prosocial: 1 },
                { desc: 'ะขั ัะปััะฐะนะฝะพ ะพะฑะธะดะตะป ะดััะณะฐ', options: ['ะกะดะตะปะฐัั ะฒะธะด ััะพ ะฝะธัะตะณะพ','ะะทะฒะธะฝะธัััั','ะะฑะฒะธะฝะธัั ะตะณะพ'], prosocial: 1 },
                { desc: 'ะะพะฒะตะฝัะบะธะน ัะตะฑัะฝะพะบ ััะพะธั ะพะดะธะฝ', options: ['ะะต ะพะฑัะฐัะฐัั ะฒะฝะธะผะฐะฝะธั','ะะพะทะฒะฐัั ะธะณัะฐัั','ะะพัะผะพััะตัั ะธ ัะนัะธ'], prosocial: 1 },
                { desc: 'ะขั ะฝะฐััะป ะบะพัะตะปัะบ ะฝะฐ ัะปะธัะต', options: ['ะะฐะฑัะฐัั ะดะตะฝัะณะธ','ะัะฝะตััะธ ะฒ ะฟะพะปะธัะธั','ะััะฐะฒะธัั'], prosocial: 1 },
                { desc: 'ะะดะฝะพะบะปะฐััะฝะธะบ ัะฟะธััะฒะฐะตั ั ัะตะฑั', options: ['ะะฐัั ัะฟะธัะฐัั','ะะฐะบัััั ัะตััะฐะดั','ะกะบะฐะทะฐัั ััะธัะตะปั'], prosocial: 2 },
                { desc: 'ะััะทัั ะทะพะฒัั ะณัะปััั, ะฝะพ ัั ะพะฑะตัะฐะป ะฟะพะผะพัั ะผะฐะผะต', options: ['ะฃะฑะตะถะฐัั ะณัะปััั','ะะพะผะพัั ะผะฐะผะต ะธ ะฟะพัะพะผ ะฟะพะนัะธ','ะกะพะฒัะฐัั ะผะฐะผะต'], prosocial: 1 },
                { desc: 'ะขั ะฒะธะดะธัั ััะพ ะพะฑะธะถะฐัั ะผะปะฐะดัะตะณะพ', options: ['ะัะพะนัะธ ะผะธะผะพ','ะะฐัััะฟะธัััั','ะัะธัะพะตะดะธะฝะธัััั'], prosocial: 1 },
                { desc: 'ะฃัะธัะตะปั ะฝะตัะฟัะฐะฒะตะดะปะธะฒะพ ะฟะพััะณะฐะป', options: ['ะะฐะณััะฑะธัั','ะกะฟะพะบะพะนะฝะพ ะพะฑัััะฝะธัั','ะะฐะฟะปะฐะบะฐัั'], prosocial: 1 },
                { desc: 'ะััะณ ัะฐััะบะฐะทะฐะป ัะตะฑะต ัะตะบัะตั', options: ['ะะฐััะบะฐะทะฐัั ะฒัะตะผ','ะกะพััะฐะฝะธัั ัะตะบัะตั','ะะพัะผะตััััั ะฝะฐะด ะฝะธะผ'], prosocial: 1 },
                { desc: 'ะขั ะพะฑะตัะฐะป ะฝะพ ะฝะต ััะฟะตะฒะฐะตัั', options: ['ะัะพะผะพะปัะฐัั','ะัะตะดัะฟัะตะดะธัั ะทะฐัะฐะฝะตะต','ะกะพะฒัะฐัั ััะพ ะทะฐะฑะพะปะตะป'], prosocial: 1 }
            ]}
        },
        selfCare: {
            '3-4': ['ะััั ััะบะธ','ะััั ะปะพะถะบะพะน','ะะธัั ะธะท ัะฐัะบะธ','ะกะฝะธะผะฐัั ะพะฑัะฒั','ะฅะพะดะธัั ะฝะฐ ะณะพััะพะบ','ะััั ัััะบัั'],
            '4-5': ['ะะดะตะฒะฐัััั','ะงะธััะธัั ะทัะฑั','ะฃะฑะธัะฐัั ะธะณัััะบะธ','ะััั ััะบะธ ั ะผัะปะพะผ','ะััั ะฒะธะปะบะพะน','ะฅะพะดะธัั ะฒ ััะฐะปะตั ัะฐะผ','ะะฐะดะตะฒะฐัั ะพะฑัะฒั','ะะฐัััััะฒะฐัััั'],
            '5-6': ['ะะฐัััะณะธะฒะฐัั ะฟัะณะพะฒะธัั','ะะฐะปะธะฒะฐัั ะฒะพะดั','ะะฐะฟัะฐะฒะปััั ะบัะพะฒะฐัั','ะััััั ะฒ ะดััะต','ะะฐะบััะฒะฐัั ะฝะฐ ััะพะป','ะกะบะปะฐะดัะฒะฐัั ะพะดะตะถะดั','ะะดะตะฒะฐัััั ะฟะพ ะฟะพะณะพะดะต','ะงะธััะธัั ะทัะฑั ัััะพะผ ะธ ะฒะตัะตัะพะผ','ะฃะฑะธัะฐัั ะทะฐ ัะพะฑะพะน ะฟะพััะดั','ะะพะปะธะฒะฐัั ัะฒะตัั'],
            '6-7': ['ะะฐะฒัะทัะฒะฐัั ัะฝััะบะธ','ะกะพะฑะธัะฐัั ััะบะทะฐะบ','ะะพัะพะฒะธัั ะฑััะตัะฑัะพะด','ะััั ะฟะพััะดั','ะะปะฐะดะธัั ะฟัะพัััะต ะฒะตัะธ','ะัะธัะธะฒะฐัั ะฟัะณะพะฒะธัั','ะฅะพะดะธัั ะฒ ะผะฐะณะฐะทะธะฝ ััะดะพะผ','ะะพะปัะทะพะฒะฐัััั ัะฐัะฐะผะธ','ะะฒะพะฝะธัั ะฟะพ ัะตะปะตัะพะฝั','ะกัะธัะฐัั ะฝะพัะบะธ','ะะฐะทะพะณัะตะฒะฐัั ะตะดั','ะะปะฐะฝะธัะพะฒะฐัั ัะฒะพะน ะดะตะฝั']
        }
    }
};

// === SHAPE DRAWING HELPERS ===
const SHAPE_SVG = {
    'ะบััะณ':          '<circle cx="50" cy="50" r="40" fill="currentColor"/>',
    'ะบะฒะฐะดัะฐั':       '<rect x="12" y="12" width="76" height="76" fill="currentColor"/>',
    'ััะตัะณะพะปัะฝะธะบ':   '<polygon points="50,8 92,88 8,88" fill="currentColor"/>',
    'ะฟััะผะพัะณะพะปัะฝะธะบ': '<rect x="6" y="20" width="88" height="56" fill="currentColor"/>',
    'ะพะฒะฐะป':          '<ellipse cx="50" cy="50" rx="44" ry="30" fill="currentColor"/>',
    'ัะพะผะฑ':          '<polygon points="50,6 94,50 50,94 6,50" fill="currentColor"/>',
    'ะทะฒะตะทะดะฐ':        '<polygon points="50,5 61,38 95,38 68,60 78,93 50,73 22,93 32,60 5,38 39,38" fill="currentColor"/>',
    'ััะฐะฟะตัะธั':      '<polygon points="25,18 75,18 95,82 5,82" fill="currentColor"/>'
};

const SHAPE_COLORS = ['#ef4444','#3b82f6','#22c55e','#f59e0b','#a855f7','#ec4899','#f97316','#0d9488'];

// =============================================
// VOICE RECORDER โ MediaRecorder + IndexedDB
// =============================================
const VoiceRecorder = {
    _db: null,
    _recorder: null,
    _stream: null,
    _chunks: [],
    _analyser: null,
    _animFrame: null,
    DB_NAME: 'gosha_audio',
    STORE: 'recordings',

    // โโ IndexedDB โโ
    async openDB() {
        if (this._db) return this._db;
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(this.DB_NAME, 1);
            req.onupgradeneeded = () => {
                const db = req.result;
                if (!db.objectStoreNames.contains(this.STORE)) {
                    db.createObjectStore(this.STORE, { keyPath: 'id' });
                }
            };
            req.onsuccess = () => { this._db = req.result; resolve(this._db); };
            req.onerror = () => reject(req.error);
        });
    },

    async save(id, blob, meta) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(this.STORE, 'readwrite');
            tx.objectStore(this.STORE).put({ id, blob, meta, date: new Date().toISOString() });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },

    async get(id) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(this.STORE, 'readonly');
            const req = tx.objectStore(this.STORE).get(id);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = () => reject(req.error);
        });
    },

    async getAllForTest(testPrefix) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(this.STORE, 'readonly');
            const store = tx.objectStore(this.STORE);
            const results = [];
            const req = store.openCursor();
            req.onsuccess = () => {
                const cursor = req.result;
                if (cursor) {
                    if (cursor.value.id.startsWith(testPrefix)) results.push(cursor.value);
                    cursor.continue();
                } else resolve(results);
            };
            req.onerror = () => reject(req.error);
        });
    },

    async deleteForTest(testPrefix) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(this.STORE, 'readwrite');
            const store = tx.objectStore(this.STORE);
            const req = store.openCursor();
            req.onsuccess = () => {
                const cursor = req.result;
                if (cursor) {
                    if (cursor.value.id.startsWith(testPrefix)) cursor.delete();
                    cursor.continue();
                } else resolve();
            };
            tx.onerror = () => reject(tx.error);
        });
    },

    // โโ Format detection โโ
    getMimeType() {
        if (typeof MediaRecorder === 'undefined') return null;
        const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/ogg;codecs=opus'];
        return types.find(t => MediaRecorder.isTypeSupported(t)) || '';
    },

    isSupported() {
        return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && typeof MediaRecorder !== 'undefined' && this.getMimeType());
    },

    // โโ Recording โโ
    async requestMic() {
        try {
            this._stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            return true;
        } catch(e) {
            return false;
        }
    },

    startRecording(onLevel) {
        if (!this._stream) return false;
        this._chunks = [];
        const mime = this.getMimeType();
        const options = mime ? { mimeType: mime } : {};

        this._recorder = new MediaRecorder(this._stream, options);
        this._recorder.ondataavailable = (e) => { if (e.data.size > 0) this._chunks.push(e.data); };
        this._recorder.start(100);

        // Analyser for audio level visualization
        if (onLevel) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaStreamSource(this._stream);
                this._analyser = ctx.createAnalyser();
                this._analyser.fftSize = 256;
                src.connect(this._analyser);
                const data = new Uint8Array(this._analyser.frequencyBinCount);
                const tick = () => {
                    if (!this._analyser) return;
                    this._analyser.getByteFrequencyData(data);
                    const avg = data.reduce((s, v) => s + v, 0) / data.length;
                    onLevel(avg / 128); // 0..1 normalized
                    this._animFrame = requestAnimationFrame(tick);
                };
                tick();
            } catch(e) {}
        }
        return true;
    },

    stopRecording() {
        return new Promise((resolve) => {
            if (!this._recorder || this._recorder.state === 'inactive') {
                resolve(null); return;
            }
            this._recorder.onstop = () => {
                const blob = new Blob(this._chunks, { type: this._recorder.mimeType || 'audio/webm' });
                resolve(blob);
            };
            this._recorder.stop();
            if (this._animFrame) { cancelAnimationFrame(this._animFrame); this._animFrame = null; }
            this._analyser = null;
        });
    },

    releaseMic() {
        if (this._stream) {
            this._stream.getTracks().forEach(t => t.stop());
            this._stream = null;
        }
        if (this._animFrame) { cancelAnimationFrame(this._animFrame); this._animFrame = null; }
        this._analyser = null;
        this._recorder = null;
    },

    createURL(blob) {
        return URL.createObjectURL(blob);
    }
};

// =============================================
// TESTING MODULE
// =============================================
const Testing = {
    _profile: null,
    _results: [],
    _session: null,    // ัะตะบััะฐั ัะตััะธั ัะตััะธัะพะฒะฐะฝะธั
    _taskQueue: [],
    _taskIdx: 0,
    _taskResults: {},  // { cognitive: [], speech: [], motor: [], social: [] }
    _startTime: 0,

    // โโ Init โโ
    init() {
        AudioMgr.stop();
        this._loadProfile();
        this._loadResults();
        if (!this._profile) {
            this._showSetup();
        } else {
            this._showDashboard();
        }
        App.navigate('testing', 'ะขะตััะธัะพะฒะฐะฝะธะต');
    },

    // โโ LocalStorage (ั ะพะฑัะฐะฑะพัะบะพะน ะพัะธะฑะพะบ ะฟะตัะตะฟะพะปะฝะตะฝะธั) โโ
    _loadProfile() {
        try { this._profile = JSON.parse(localStorage.getItem('testing_profile')); } catch(e) { this._profile = null; }
    },
    _saveProfile() {
        try {
            localStorage.setItem('testing_profile', JSON.stringify(this._profile));
        } catch(e) {
            console.warn('[Testing] localStorage full, cannot save profile:', e);
        }
    },
    _loadResults() {
        try { this._results = JSON.parse(localStorage.getItem('testing_results')) || []; } catch(e) { this._results = []; }
    },
    _saveResults() {
        try {
            localStorage.setItem('testing_results', JSON.stringify(this._results));
        } catch(e) {
            // ะัะธ ะฟะตัะตะฟะพะปะฝะตะฝะธะธ โ ัะดะฐะปัะตะผ ััะฐััะต ัะตะทัะปััะฐัั
            console.warn('[Testing] localStorage full, trimming old results');
            try {
                if (this._results.length > 3) {
                    this._results = this._results.slice(-3);
                    localStorage.setItem('testing_results', JSON.stringify(this._results));
                }
            } catch(e2) { console.error('[Testing] Cannot save results:', e2); }
        }
    },

    // โโ Helpers โโ
    _shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    },
    _rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },

    // =============================================
    // SETUP SCREEN (ะฟะตัะฒัะน ะทะฐะฟััะบ)
    // =============================================
    _showSetup() {
        this._hideProgress();
        const el = document.getElementById('testing-content');
        el.innerHTML = `
            <div class="tst-setup">
                <div class="tst-mascot">๐ฆ</div>
                <div class="tst-setup-title">ะัะธะฒะตั! ะะฐะฒะฐะน ัะทะฝะฐะตะผ, ััะพ ัั ัะถะต ัะผะตะตัั!</div>
                <div class="tst-setup-sub">ะกะฝะฐัะฐะปะฐ ะฒัะฑะตัะธ ะฒะพะทัะฐัั ัะตะฑัะฝะบะฐ:</div>
                <div class="tst-age-grid">
                    <button class="tst-age-btn" onclick="Testing._selectAge('3-4')">
                        <span class="tst-age-num">3โ4</span><span class="tst-age-label">ะณะพะดะฐ</span>
                    </button>
                    <button class="tst-age-btn" onclick="Testing._selectAge('4-5')">
                        <span class="tst-age-num">4โ5</span><span class="tst-age-label">ะปะตั</span>
                    </button>
                    <button class="tst-age-btn" onclick="Testing._selectAge('5-6')">
                        <span class="tst-age-num">5โ6</span><span class="tst-age-label">ะปะตั</span>
                    </button>
                    <button class="tst-age-btn" onclick="Testing._selectAge('6-7')">
                        <span class="tst-age-num">6โ7</span><span class="tst-age-label">ะปะตั</span>
                    </button>
                </div>
            </div>`;
    },

    _selectAge(age) {
        const name = (typeof childName !== 'undefined' && childName) ? childName :
                     localStorage.getItem('child_name') || '';
        this._profile = { age_group: age, name: name };
        this._saveProfile();
        this._showDashboard();
    },

    // =============================================
    // DASHBOARD
    // =============================================
    _showDashboard() {
        this._hideProgress();
        // Remove lingering progress bar from test
        const oldProg = document.getElementById('tst-progress-wrap');
        if (oldProg) oldProg.remove();

        const el = document.getElementById('testing-content');
        const lastResult = this._results.length ? this._results[this._results.length - 1] : null;
        const prevResult = this._results.length > 1 ? this._results[this._results.length - 2] : null;
        const age = this._profile.age_group;

        // Age norms reference (approximate)
        const AGE_NORMS = {
            '3-4': { low: 0.45, mid: 0.65, high: 0.85 },
            '4-5': { low: 0.50, mid: 0.70, high: 0.85 },
            '5-6': { low: 0.55, mid: 0.72, high: 0.88 },
            '6-7': { low: 0.55, mid: 0.75, high: 0.90 }
        };
        const norms = AGE_NORMS[age] || AGE_NORMS['4-5'];

        let chartHtml = '';
        if (lastResult) {
            chartHtml = `
                <div class="tst-chart-wrap">
                    <canvas id="tst-spider" width="320" height="320"></canvas>
                </div>
                <div class="tst-norm-hint">ะัะธะตะฝัะธั ะดะปั ${age} ะปะตั: ${Math.round(norms.low*100)}โ${Math.round(norms.high*100)}%</div>
                <div class="tst-scores-row">
                    ${this._scoreBadgeWithDelta('ะะพะณะฝะธัะธั', lastResult.blocks.cognitive?.score, prevResult?.blocks?.cognitive?.score, '#a855f7')}
                    ${this._scoreBadgeWithDelta('ะะตัั', lastResult.blocks.speech?.score, prevResult?.blocks?.speech?.score, '#3b82f6')}
                    ${this._scoreBadgeWithDelta('ะะพัะพัะธะบะฐ', lastResult.blocks.motor?.score, prevResult?.blocks?.motor?.score, '#22c55e')}
                    ${this._scoreBadgeWithDelta('ะกะพัะธัะผ', lastResult.blocks.social?.score, prevResult?.blocks?.social?.score, '#f59e0b')}
                </div>`;

            // Sparklines if we have more than 1 result
            if (this._results.length > 1) {
                chartHtml += '<div class="tst-sparklines">';
                const blockMap = { cognitive: '๐ง', speech: '๐ฌ', motor: 'โ', social: 'โค๏ธ' };
                for (const [key, emoji] of Object.entries(blockMap)) {
                    const points = this._results.slice(-8).map(r => r.blocks[key]?.score ?? null).filter(v => v !== null && v >= 0);
                    if (points.length > 1) {
                        chartHtml += `<div class="tst-sparkline-row">
                            <span class="tst-sparkline-label">${emoji}</span>
                            <canvas class="tst-sparkline-canvas" data-block="${key}" data-points="${points.join(',')}" width="120" height="32"></canvas>
                        </div>`;
                    }
                }
                chartHtml += '</div>';
            }
        } else {
            chartHtml = `<div class="tst-no-results">
                <div style="font-size:48px;margin-bottom:12px;">๐</div>
                <div>ะัะพะนะดะธัะต ะฟะตัะฒัะน ัะตัั, ััะพะฑั ัะฒะธะดะตัั ัะตะทัะปััะฐัั</div>
            </div>`;
        }

        let historyHtml = '';
        if (this._results.length) {
            const blockNames = { cognitive: '๐ง ะะพะณะฝะธัะธั', speech: '๐ฌ ะะตัั', motor: 'โ ะะพัะพัะธะบะฐ', social: 'โค๏ธ ะกะพัะธัะผ' };
            historyHtml = '<div class="tst-history-title">ะััะพัะธั</div><div class="tst-history-list">';
            const shown = this._results.slice(-5).reverse();
            for (let ri = 0; ri < shown.length; ri++) {
                const r = shown[ri];
                const d = new Date(r.date);
                const dateStr = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
                const avg = this._avgScore(r);
                const pct = Math.round(avg * 100);

                // ะขะธะฟ ะธ ะผะตัะบะฐ
                let typeLabel;
                if (r.type === 'full') {
                    typeLabel = '<span class="tst-hist-type">ะะพะปะฝัะน</span>';
                } else {
                    const blockKey = r.miniBlock || Object.keys(r.blocks)[0] || '';
                    const label = blockKey ? (blockNames[blockKey] || blockKey) : 'ะะธะฝะธ';
                    typeLabel = `<span class="tst-hist-type tst-hist-mini-label">${label}</span>`;
                }

                // ะะตัะฐะปะธะทะฐัะธั ะฟะพ ะฑะปะพะบะฐะผ
                let detailsHtml = '';
                for (const [b, data] of Object.entries(r.blocks)) {
                    if (data.voiceOnly || data.score == null || data.score < 0) {
                        detailsHtml += `<div class="tst-hist-block">
                            <div class="tst-hist-block-head">
                                <span class="tst-hist-detail-name">${blockNames[b] || b}</span>
                                <span class="tst-hist-detail-pct" style="color:var(--text2)">๐</span>
                            </div>
                            <div class="tst-hist-block-label" style="color:var(--text2)">ะะพะปะพัะพะฒัะต ะทะฐะฟะธัะธ</div>
                        </div>`;
                        continue;
                    }
                    const bPct = Math.round(data.score * 100);
                    const bColor = this._scoreColor(data.score);
                    const bLabel = this._scoreLabel(data.score);
                    const bTip = this._blockTip(b, data.score);
                    const timeInfo = data.avgTime ? `<div class="tst-hist-block-time">~${data.avgTime}ั/ะทะฐะดะฐะฝะธะต</div>` : '';
                    detailsHtml += `<div class="tst-hist-block">
                        <div class="tst-hist-block-head">
                            <span class="tst-hist-detail-name">${blockNames[b] || b}</span>
                            <span class="tst-hist-detail-pct" style="color:${bColor}">${bPct}%</span>
                        </div>
                        <div class="tst-hist-detail-bar"><span style="width:${bPct}%;background:${bColor}"></span></div>
                        <div class="tst-hist-block-label" style="color:${bColor}">${bLabel}</div>
                        ${timeInfo}
                        ${bTip ? `<div class="tst-hist-block-tip">${bTip}</div>` : ''}
                    </div>`;
                }

                // ะะฝะพะฟะบะฐ ยซะะฐะฟะธัะธยป ะตัะปะธ ะตััั audioPrefix
                if (r.audioPrefix) {
                    detailsHtml += `<div class="tst-hist-audio-wrap" id="tst-hist-audio-${ri}">
                        <button class="tst-hist-audio-btn" onclick="Testing._loadHistAudio('${r.audioPrefix}', ${ri})">๐ ะะพะบะฐะทะฐัั ะทะฐะฟะธัะธ</button>
                    </div>`;
                }

                historyHtml += `<div class="tst-hist-accordion" id="tst-ha-${ri}">
                    <div class="tst-history-item" onclick="document.getElementById('tst-ha-${ri}').classList.toggle('open')">
                        <span class="tst-hist-date">${dateStr}</span>
                        ${typeLabel}
                        <span class="tst-hist-score" style="color:${this._scoreColor(avg)}">${pct}%</span>
                        <span class="tst-hist-arrow">โบ</span>
                    </div>
                    <div class="tst-hist-details">${detailsHtml}</div>
                </div>`;
            }
            historyHtml += '</div>';
        }

        el.innerHTML = `
            <div class="tst-dash">
                <div class="tst-dash-header">
                    <div class="tst-dash-age">ะะพะทัะฐัั: <strong>${age} ะปะตั</strong></div>
                    <button class="tst-change-age" onclick="Testing._showSetup()">ะะทะผะตะฝะธัั</button>
                </div>
                ${chartHtml}
                <div class="tst-actions">
                    <button class="tst-start-btn tst-btn-full" onclick="Testing.startFull()">
                        <span>๐งช</span> ะะพะปะฝัะน ัะตัั
                    </button>
                    <div class="tst-mini-row">
                        <button class="tst-mini-btn" onclick="Testing.startMini('cognitive')">๐ง ะะพะณะฝะธัะธั</button>
                        <button class="tst-mini-btn" onclick="Testing.startMini('speech')">๐ฌ ะะตัั</button>
                        <button class="tst-mini-btn" onclick="Testing.startMini('motor')">โ ะะพัะพัะธะบะฐ</button>
                        <button class="tst-mini-btn" onclick="Testing.startMini('social')">โค๏ธ ะกะพัะธัะผ</button>
                    </div>
                </div>
                ${historyHtml}
            </div>`;

        if (lastResult) {
            requestAnimationFrame(() => {
                this._drawSpider(lastResult);
                this._drawSparklines();
            });
        }
    },

    // โโ Score badge with delta arrow โโ
    _scoreBadgeWithDelta(label, score, prevScore, color) {
        const pct = score != null && score >= 0 ? Math.round(score * 100) : 'โ';
        let deltaHtml = '';
        if (prevScore != null && prevScore >= 0 && score != null && score >= 0) {
            const diff = Math.round((score - prevScore) * 100);
            if (diff > 0) deltaHtml = `<span class="tst-delta tst-delta-up">โ${diff}</span>`;
            else if (diff < 0) deltaHtml = `<span class="tst-delta tst-delta-down">โ${Math.abs(diff)}</span>`;
        }
        return `<div class="tst-score-badge">
            <div class="tst-sb-val" style="color:${color}">${pct}%</div>
            ${deltaHtml}
            <div class="tst-sb-label">${label}</div>
        </div>`;
    },

    // โโ Sparkline drawing โโ
    _drawSparklines() {
        document.querySelectorAll('.tst-sparkline-canvas').forEach(canvas => {
            const points = canvas.dataset.points.split(',').map(Number);
            if (points.length < 2) return;
            const ctx = canvas.getContext('2d');
            const W = 120, H = 32;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = W * dpr;
            canvas.height = H * dpr;
            ctx.scale(dpr, dpr);

            const min = Math.max(0, Math.min(...points) - 0.1);
            const max = Math.min(1, Math.max(...points) + 0.1);
            const range = max - min || 1;
            const xStep = (W - 8) / (points.length - 1);

            // Fill gradient
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const lineColor = isDark ? '#54ACBF' : '#3b82f6';

            ctx.beginPath();
            points.forEach((v, i) => {
                const x = 4 + i * xStep;
                const y = H - 4 - ((v - min) / range) * (H - 8);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 1.5;
            ctx.stroke();

            // End dot
            const lastX = 4 + (points.length - 1) * xStep;
            const lastY = H - 4 - ((points[points.length - 1] - min) / range) * (H - 8);
            ctx.fillStyle = lineColor;
            ctx.beginPath();
            ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
            ctx.fill();
        });
    },

    _avgScore(r) {
        const blocks = ['cognitive','speech','motor','social'];
        let sum = 0, cnt = 0;
        blocks.forEach(b => {
            if (r.blocks[b] && r.blocks[b].score != null && r.blocks[b].score >= 0) {
                sum += r.blocks[b].score; cnt++;
            }
        });
        return cnt ? sum / cnt : 0;
    },

    _scoreColor(score) {
        if (score >= 0.8) return '#22c55e';
        if (score >= 0.6) return '#f59e0b';
        if (score >= 0.4) return '#f97316';
        return '#ef4444';
    },

    // โโ Spider Chart (canvas) โโ
    _drawSpider(result) {
        const canvas = document.getElementById('tst-spider');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = 320, H = 320;
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        const cx = W / 2, cy = H / 2, R = 95;

        // ะััะพะบะฐั ะฟะปะพัะฝะพััั ะฟะธะบัะตะปะตะน
        const dpr = window.devicePixelRatio || 1;
        canvas.width = W * dpr;
        canvas.height = H * dpr;
        ctx.scale(dpr, dpr);

        const labels = ['ะะพะณะฝะธัะธั', 'ะะตัั', 'ะะพัะพัะธะบะฐ', 'ะกะพัะธัะผ'];
        const colors = ['#a855f7', '#3b82f6', '#22c55e', '#f59e0b'];
        const scores = [
            (result.blocks.cognitive?.score != null && result.blocks.cognitive?.score >= 0) ? result.blocks.cognitive.score : 0,
            (result.blocks.speech?.score != null && result.blocks.speech?.score >= 0) ? result.blocks.speech.score : 0,
            (result.blocks.motor?.score != null && result.blocks.motor?.score >= 0) ? result.blocks.motor.score : 0,
            (result.blocks.social?.score != null && result.blocks.social?.score >= 0) ? result.blocks.social.score : 0
        ];
        const n = 4;

        // ะกะตัะบะฐ
        ctx.strokeStyle = 'rgba(128,128,128,0.15)';
        ctx.lineWidth = 1;
        for (let level = 0.25; level <= 1; level += 0.25) {
            ctx.beginPath();
            for (let i = 0; i <= n; i++) {
                const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                const x = cx + Math.cos(angle) * R * level;
                const y = cy + Math.sin(angle) * R * level;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        // ะัะธ
        ctx.strokeStyle = 'rgba(128,128,128,0.2)';
        for (let i = 0; i < n; i++) {
            const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(angle) * R, cy + Math.sin(angle) * R);
            ctx.stroke();
        }

        // ะะฑะปะฐััั ะดะฐะฝะฝัั
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        ctx.fillStyle = isDark ? 'rgba(84,172,191,0.15)' : 'rgba(96,165,250,0.15)';
        ctx.strokeStyle = isDark ? '#54ACBF' : '#3b82f6';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
            const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            const val = Math.max(scores[i], 0.05);
            const x = cx + Math.cos(angle) * R * val;
            const y = cy + Math.sin(angle) * R * val;
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // ะขะพัะบะธ
        for (let i = 0; i < n; i++) {
            const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            const val = Math.max(scores[i], 0.05);
            const x = cx + Math.cos(angle) * R * val;
            const y = cy + Math.sin(angle) * R * val;
            ctx.fillStyle = colors[i];
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        // ะะพะดะฟะธัะธ โ ัะผะฝะพะต ะฒััะฐะฒะฝะธะฒะฐะฝะธะต, ััะพะฑั ะฝะต ะพะฑัะตะทะฐะปะพัั
        ctx.fillStyle = isDark ? '#d4f0f5' : '#1a1f3c';
        ctx.font = '13px "Plus Jakarta Sans", sans-serif';
        const labelDist = R + 24;
        for (let i = 0; i < n; i++) {
            const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            let x = cx + Math.cos(angle) * labelDist;
            let y = cy + Math.sin(angle) * labelDist;
            // i=0 top, i=1 right, i=2 bottom, i=3 left
            if (i === 0) { ctx.textAlign = 'center'; y -= 6; }
            else if (i === 1) { ctx.textAlign = 'left'; x += 4; y += 5; }
            else if (i === 2) { ctx.textAlign = 'center'; y += 14; }
            else if (i === 3) { ctx.textAlign = 'right'; x -= 4; y += 5; }
            ctx.fillText(labels[i], x, y);
        }
    },

    // =============================================
    // START TEST
    // =============================================
    startFull() {
        this._session = {
            type: 'full',
            age_group: this._profile.age_group,
            date: new Date().toISOString()
        };
        this._taskResults = { cognitive: [], speech: [], motor: [], social: [] };
        this._starsCollected = 0;
        this._paused = false;
        this._buildFullQueue();
        this._taskIdx = 0;
        this._startTime = Date.now();
        this._showIntro();
    },

    startMini(block) {
        this._session = {
            type: 'mini',
            age_group: this._profile.age_group,
            date: new Date().toISOString(),
            miniBlock: block
        };
        this._taskResults = { cognitive: [], speech: [], motor: [], social: [] };
        this._starsCollected = 0;
        this._paused = false;
        this._buildMiniQueue(block);
        this._taskIdx = 0;
        this._startTime = Date.now();
        this._showIntro();
    },

    _buildFullQueue() {
        const age = this._profile.age_group;
        this._taskQueue = [];

        // ะะพะณะฝะธัะธะฒะฝัะน ะฑะปะพะบ
        this._taskQueue.push({ type: 'block-title', block: 'cognitive', title: '๐ง ะัะพะฒะตัะธะผ ัะผะตะบะฐะปะบั!' });
        this._taskQueue.push(...this._getCountingTasks(age));
        if (TESTING_TASKS.cognitive.colors[age]) this._taskQueue.push(...this._getColorTasks(age));
        this._taskQueue.push(...this._getShapeTasks(age));
        this._taskQueue.push(...this._getOddTasks(age));
        this._taskQueue.push(...this._getSequenceTasks(age));
        this._taskQueue.push({ type: 'pause', emoji: 'โญ' });

        // ะะตัะตะฒะพะน ะฑะปะพะบ
        this._taskQueue.push({ type: 'block-title', block: 'speech', title: '๐ฌ ะัะพะฒะตัะธะผ ัะปะพะฒะฐัะฝัะน ะทะฐะฟะฐั!' });
        this._taskQueue.push(...this._getVocabTasks(age));
        if (TESTING_TASKS.speech.grammar[age]) this._taskQueue.push(...this._getGrammarTasks(age));
        this._taskQueue.push(...this._getRecordWordTasks(age));
        this._taskQueue.push(...this._getRecordDescribeTasks(age));
        this._taskQueue.push({ type: 'pause', emoji: '๐' });

        // ะะพัะพัะฝัะน ะฑะปะพะบ
        this._taskQueue.push({ type: 'block-title', block: 'motor', title: 'โ ะัะพะฒะตัะธะผ ะปะพะฒะบะพััั!' });
        this._taskQueue.push(...this._getCoinTasks(age));
        this._taskQueue.push(...this._getDotTasks(age));
        this._taskQueue.push({ type: 'pause', emoji: '๐ซ' });

        // ะกะพัะธะฐะปัะฝะพ-ัะผะพัะธะพะฝะฐะปัะฝัะน ะฑะปะพะบ
        this._taskQueue.push({ type: 'block-title', block: 'social', title: 'โค๏ธ ะัะพะฒะตัะธะผ ะฟะพะฝะธะผะฐะฝะธะต ััะฒััะฒ!' });
        this._taskQueue.push(...this._getEmotionTasks(age));
        this._taskQueue.push(...this._getSituationTasks(age));
        this._taskQueue.push(...this._getSelfCareTasks(age));

        // ะคะธะฝะฐะป
        this._taskQueue.push({ type: 'finish' });
    },

    _buildMiniQueue(block) {
        const age = this._profile.age_group;
        this._taskQueue = [];
        this._taskQueue.push({ type: 'block-title', block, title: { cognitive: '๐ง ะะพะณะฝะธัะธั', speech: '๐ฌ ะะตัั', motor: 'โ ะะพัะพัะธะบะฐ', social: 'โค๏ธ ะกะพัะธัะผ' }[block] });

        if (block === 'cognitive') {
            this._taskQueue.push(...this._getCountingTasks(age));
            if (TESTING_TASKS.cognitive.colors[age]) this._taskQueue.push(...this._getColorTasks(age));
            this._taskQueue.push(...this._getShapeTasks(age));
            this._taskQueue.push(...this._getOddTasks(age));
            this._taskQueue.push(...this._getSequenceTasks(age));
        } else if (block === 'speech') {
            this._taskQueue.push(...this._getVocabTasks(age));
            if (TESTING_TASKS.speech.grammar[age]) this._taskQueue.push(...this._getGrammarTasks(age));
            this._taskQueue.push(...this._getRecordWordTasks(age));
            this._taskQueue.push(...this._getRecordDescribeTasks(age));
        } else if (block === 'motor') {
            this._taskQueue.push(...this._getCoinTasks(age));
            this._taskQueue.push(...this._getDotTasks(age));
        } else if (block === 'social') {
            this._taskQueue.push(...this._getEmotionTasks(age));
            this._taskQueue.push(...this._getSituationTasks(age));
            this._taskQueue.push(...this._getSelfCareTasks(age));
        }
        this._taskQueue.push({ type: 'finish' });
    },

    // โโ Task generators โโ
    _getCountingTasks(age) {
        const cfg = TESTING_TASKS.cognitive.counting[age];
        const tasks = [];
        const emojis = ['๐','๐','โญ','๐','๐','๐','๐ฆ','๐ธ'];
        for (let i = 0; i < cfg.rounds; i++) {
            if (cfg.arithmetic) {
                tasks.push({ type: 'arithmetic', block: 'cognitive', id: `counting_${i}` });
            } else {
                const count = this._rand(1, cfg.max);
                const emoji = emojis[this._rand(0, emojis.length - 1)];
                tasks.push({ type: 'counting', block: 'cognitive', id: `counting_${i}`, count, emoji, max: cfg.max });
            }
        }
        return tasks;
    },

    _getColorTasks(age) {
        const cfg = TESTING_TASKS.cognitive.colors[age];
        if (!cfg) return [];
        const shuffled = this._shuffle([...cfg.items]);
        return shuffled.slice(0, cfg.rounds).map((c, i) => ({
            type: 'colors', block: 'cognitive', id: `colors_${i}`,
            target: c, allColors: cfg.items
        }));
    },

    _getShapeTasks(age) {
        const cfg = TESTING_TASKS.cognitive.shapes[age];
        const shuffled = this._shuffle([...cfg.shapes]);
        return shuffled.slice(0, cfg.rounds).map((s, i) => ({
            type: 'shapes', block: 'cognitive', id: `shapes_${i}`,
            target: s, allShapes: cfg.shapes
        }));
    },

    _getOddTasks(age) {
        const cfg = TESTING_TASKS.cognitive.oddOneOut[age];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(3, shuffled.length)).map((s, i) => ({
            type: 'oddOneOut', block: 'cognitive', id: `odd_${i}`, set: s
        }));
    },

    _getSequenceTasks(age) {
        const cfg = TESTING_TASKS.cognitive.sequence[age];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(2, shuffled.length)).map((s, i) => ({
            type: 'sequence', block: 'cognitive', id: `seq_${i}`, set: s
        }));
    },

    _getVocabTasks(age) {
        const cfg = TESTING_TASKS.speech.vocabulary[age];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(4, shuffled.length)).map((s, i) => ({
            type: 'vocabulary', block: 'speech', id: `vocab_${i}`, set: s
        }));
    },

    _getGrammarTasks(age) {
        const cfg = TESTING_TASKS.speech.grammar[age];
        if (!cfg) return [];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(3, shuffled.length)).map((s, i) => ({
            type: 'grammar', block: 'speech', id: `grammar_${i}`, set: s
        }));
    },

    _getCoinTasks(age) {
        return [{ type: 'coins', block: 'motor', id: 'coins_0', age }];
    },

    _getDotTasks(age) {
        return [{ type: 'dots', block: 'motor', id: 'dots_0', age }];
    },

    _getEmotionTasks(age) {
        const cfg = TESTING_TASKS.social.emotions[age];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(3, shuffled.length)).map((s, i) => ({
            type: 'emotions', block: 'social', id: `emo_${i}`, set: s
        }));
    },

    _getSituationTasks(age) {
        const cfg = TESTING_TASKS.social.situations[age];
        const shuffled = this._shuffle([...cfg.sets]);
        return shuffled.slice(0, Math.min(3, shuffled.length)).map((s, i) => ({
            type: 'situations', block: 'social', id: `sit_${i}`, set: s
        }));
    },

    _getSelfCareTasks(age) {
        return [{ type: 'selfCare', block: 'social', id: 'selfcare_0', age }];
    },

    _getRecordWordTasks(age) {
        const cfg = TESTING_TASKS.speech.recordWords[age];
        if (!cfg) return [];
        const shuffled = this._shuffle([...cfg.words]);
        return shuffled.slice(0, Math.min(5, shuffled.length)).map((w, i) => ({
            type: 'recordWord', block: 'speech', id: `recword_${i}`,
            word: w.word, emoji: w.emoji, sounds: w.sounds, maxSec: cfg.maxSec
        }));
    },

    _getRecordDescribeTasks(age) {
        const cfg = TESTING_TASKS.speech.recordDescribe[age];
        if (!cfg) return [];
        const scene = cfg.scenes[this._rand(0, cfg.scenes.length - 1)];
        return [{
            type: 'recordDescribe', block: 'speech', id: 'recdesc_0',
            emoji: scene.emoji, prompt: scene.prompt, maxSec: cfg.maxSec
        }];
    },

    // =============================================
    // TEST ENGINE โ ะฝะฐะฒะธะณะฐัะธั
    // =============================================
    _showIntro() {
        const el = document.getElementById('testing-content');
        el.innerHTML = `
            <div class="tst-intro">
                <div class="tst-mascot tst-mascot-bounce">๐ฆ</div>
                <div class="tst-intro-text">ะะฐะฒะฐะน ะฟะพะธะณัะฐะตะผ!<br>ะฏ ะฑัะดั ะดะฐะฒะฐัั ัะตะฑะต ะทะฐะดะฐะฝะธั.</div>
                <button class="tst-start-btn" onclick="Testing._next()">ะะฐัะธะฝะฐะตะผ! โ</button>
            </div>`;
        // Inject progress bar with exit button
        const section = document.getElementById('testing');
        if (!document.getElementById('tst-progress-wrap')) {
            const progWrap = document.createElement('div');
            progWrap.id = 'tst-progress-wrap';
            progWrap.className = 'tst-progress-header';
            progWrap.style.display = 'none';
            progWrap.innerHTML = `
                <button class="tst-exit-btn" onclick="Testing._exitTest()" title="ะัะนัะธ">โ</button>
                <div class="tst-progress"><div class="tst-progress-bar" id="tst-progress-bar"></div></div>
                <span class="tst-stars-counter" id="tst-stars-counter">โญ 0</span>`;
            section.insertBefore(progWrap, section.firstChild);
        }
    },

    _exitTest() {
        if (this._paused) return;
        this._paused = true;
        const el = document.getElementById('testing-content');
        const done = Object.values(this._taskResults).flat().length;
        el.innerHTML = `
            <div class="tst-pause-modal">
                <div class="tst-pause-modal-icon">โธ</div>
                <div class="tst-pause-modal-title">ะะฐัะทะฐ</div>
                <div class="tst-pause-modal-text">ะัะพะนะดะตะฝะพ ะทะฐะดะฐะฝะธะน: ${done}</div>
                <div class="tst-pause-modal-btns">
                    <button class="tst-start-btn tst-btn-full" onclick="Testing._resumeTest()">ะัะพะดะพะปะถะธัั โ</button>
                    <button class="tst-start-btn tst-btn-exit" onclick="Testing._exitTestConfirm()">ะกะพััะฐะฝะธัั ะธ ะฒัะนัะธ</button>
                </div>
            </div>`;
    },

    _resumeTest() {
        this._paused = false;
        // Replay current task (go back one step)
        this._taskIdx = Math.max(0, this._taskIdx - 1);
        this._next();
    },

    _exitTestConfirm() {
        // Save partial results and go to dashboard
        const done = Object.values(this._taskResults).flat().length;
        if (done > 0) {
            // Trigger finish with what we have
            this._showFinish();
        } else {
            this._hideProgress();
            this._showDashboard();
        }
    },

    _next() {
        if (this._taskIdx >= this._taskQueue.length) return;
        const task = this._taskQueue[this._taskIdx];
        this._taskIdx++;
        this._updateProgress();

        switch (task.type) {
            case 'block-title': this._showBlockTitle(task); break;
            case 'pause':       this._showPause(task); break;
            case 'finish':      this._showFinish(); break;
            case 'counting':    this._taskCounting(task); break;
            case 'arithmetic':  this._taskArithmetic(task); break;
            case 'colors':      this._taskColors(task); break;
            case 'shapes':      this._taskShapes(task); break;
            case 'oddOneOut':   this._taskOddOneOut(task); break;
            case 'sequence':    this._taskSequence(task); break;
            case 'vocabulary':  this._taskVocabulary(task); break;
            case 'grammar':     this._taskGrammar(task); break;
            case 'recordWord':  this._taskRecordWord(task); break;
            case 'recordDescribe': this._taskRecordDescribe(task); break;
            case 'coins':       this._taskCoins(task); break;
            case 'dots':        this._taskDots(task); break;
            case 'emotions':    this._taskEmotions(task); break;
            case 'situations':  this._taskSituations(task); break;
            case 'selfCare':    this._taskSelfCare(task); break;
            default: this._next();
        }
    },

    _showBlockTitle(task) {
        const el = document.getElementById('testing-content');
        el.innerHTML = `
            <div class="tst-block-title-screen">
                <div class="tst-block-emoji">${task.title.split(' ')[0]}</div>
                <div class="tst-block-text">${task.title.substring(task.title.indexOf(' ') + 1)}</div>
            </div>`;
        setTimeout(() => this._next(), 1800);
    },

    _showPause(task) {
        const el = document.getElementById('testing-content');
        const done = Object.values(this._taskResults).flat().length;
        const total = this._taskQueue.filter(t => !['block-title','pause','finish'].includes(t.type)).length;
        const correct = this._starsCollected || 0;
        const starsDisplay = 'โญ'.repeat(Math.min(correct, 10));
        el.innerHTML = `
            <div class="tst-pause-screen">
                <div style="font-size:64px">${task.emoji}</div>
                <div class="tst-pause-text">ะัะปะธัะฝะพ! ${correct > 0 ? `ะขั ัะพะฑัะฐะป ${correct} ${correct === 1 ? 'ะทะฒัะทะดะพัะบั' : correct < 5 ? 'ะทะฒัะทะดะพัะบะธ' : 'ะทะฒัะทะดะพัะตะบ'}!` : 'ะัะพะดะพะปะถะฐะตะผ!'}</div>
                <div class="tst-pause-stars">${starsDisplay}</div>
                <div class="tst-pause-progress-text">${done} ะธะท ${total} ะทะฐะดะฐะฝะธะน</div>
            </div>`;
        setTimeout(() => this._next(), 2200);
    },

    // โโ Progress bar (fixed at top of section) โโ
    _updateProgress() {
        const total = this._taskQueue.filter(t => !['block-title','pause','finish'].includes(t.type)).length;
        const done = Object.values(this._taskResults).flat().length;
        const pct = total ? Math.round(done / total * 100) : 0;
        const wrap = document.getElementById('tst-progress-wrap');
        const bar = document.getElementById('tst-progress-bar');
        const starsEl = document.getElementById('tst-stars-counter');
        if (wrap) wrap.style.display = '';
        if (bar) bar.style.width = pct + '%';
        if (starsEl) starsEl.textContent = `โญ ${this._starsCollected || 0}`;
    },

    _hideProgress() {
        const wrap = document.getElementById('tst-progress-wrap');
        if (wrap) wrap.style.display = 'none';
    },

    // โโ Record result โโ
    _record(block, id, correct, timeSec, details) {
        this._taskResults[block].push({
            id,
            result: correct ? 'correct' : 'incorrect',
            score: correct ? 1 : 0,
            time_sec: Math.round(timeSec * 10) / 10,
            details: details || {}
        });
    },

    // โโ Feedback with sound + correct answer reveal โโ
    _showFeedback(correct, cb, highlightCorrectFn) {
        // Play sound (uses global functions from app.js)
        try {
            if (correct) {
                if (typeof playCorrectSound === 'function') playCorrectSound('testing');
            } else {
                if (typeof playWrongSound === 'function') playWrongSound('testing');
            }
        } catch(e) {}

        // Disable all interactive buttons to prevent double-tap
        document.querySelectorAll('.tst-opt-btn, .tst-odd-btn, .tst-color-ball, .tst-shape-btn, .tst-emo-btn').forEach(b => {
            b.style.pointerEvents = 'none';
        });

        const overlay = document.createElement('div');
        overlay.className = 'tst-feedback ' + (correct ? 'tst-fb-correct' : 'tst-fb-wrong');
        overlay.innerHTML = correct ? 'โ' : 'โ';
        document.getElementById('testing-content').appendChild(overlay);

        if (!correct && highlightCorrectFn) {
            // After the error indicator fades, highlight correct answer
            setTimeout(() => {
                try { highlightCorrectFn(); } catch(e) {}
            }, 500);
        }

        // Update stars
        if (correct) this._starsCollected++;

        const delay = correct ? 800 : 1800; // longer on error to show correct answer
        setTimeout(() => {
            overlay.remove();
            if (cb) cb();
        }, delay);
    },

    // โโ Play tick sound (for interactions like placing items) โโ
    _audioCtx: null,
    _getAudioCtx() {
        if (!this._audioCtx || this._audioCtx.state === 'closed') {
            this._audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this._audioCtx.state === 'suspended') this._audioCtx.resume();
        return this._audioCtx;
    },
    _playTick() {
        try {
            const ctx = this._getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.setValueAtTime(0.04, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        } catch(e) {}
    },

    // โโ Play finish fanfare โโ
    _playFinishFanfare() {
        try {
            const ctx = this._getAudioCtx();
            const notes = [523, 659, 784, 1047, 1319]; // C E G C E
            let t = ctx.currentTime;
            notes.forEach((freq) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, t);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.15, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                osc.start(t); osc.stop(t + 0.45);
                t += 0.12;
            });
        } catch(e) {}
    },

    // =============================================
    // TASKS โ COGNITIVE
    // =============================================

    // โโ Counting โโ
    _taskCounting(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const items = Array(task.count).fill(task.emoji);
        // ะะตะฝะตัะธััะตะผ ะฒะฐัะธะฐะฝัั ะพัะฒะตัะพะฒ
        const options = new Set([task.count]);
        while (options.size < 4) {
            let n = this._rand(Math.max(1, task.count - 3), Math.min(task.max, task.count + 3));
            if (n !== task.count || options.size >= 3) options.add(n);
        }
        const sorted = [...options].sort((a, b) => a - b);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะพััะธัะฐะน, ัะบะพะปัะบะพ ะฟัะตะดะผะตัะพะฒ!</div>
                <div class="tst-items-grid">${items.map(e => `<span class="tst-item">${e}</span>`).join('')}</div>
                <div class="tst-options">
                    ${sorted.map(n => `<button class="tst-opt-btn" onclick="Testing._onCountAnswer(${n},${task.count},${t0},'${task.block}','${task.id}')">${n}</button>`).join('')}
                </div>
            </div>`;
    },

    _onCountAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time, { expected: correct, answered: selected });
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-opt-btn').forEach(b => {
                if (parseInt(b.textContent) === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    // โโ Arithmetic (6-7) โโ
    _taskArithmetic(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const a = this._rand(1, 9);
        const isAdd = Math.random() < 0.5;
        const op = isAdd ? '+' : 'โ';
        const b = isAdd ? this._rand(0, 9 - a) : this._rand(0, a);
        const realAnswer = isAdd ? a + b : a - b;

        const options = new Set([realAnswer]);
        while (options.size < 4) options.add(this._rand(0, 18));
        const sorted = [...options].sort((a, b) => a - b);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะกะบะพะปัะบะพ ะฑัะดะตั?</div>
                <div class="tst-math-expr">${a} ${op} ${b} = ?</div>
                <div class="tst-options">
                    ${sorted.map(n => `<button class="tst-opt-btn" onclick="Testing._onCountAnswer(${n},${realAnswer},${t0},'${task.block}','${task.id}')">${n}</button>`).join('')}
                </div>
            </div>`;
    },

    // โโ Colors โโ
    _taskColors(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const shuffled = this._shuffle([...task.allColors]);
        const shown = shuffled.slice(0, Math.min(6, shuffled.length));
        if (!shown.find(c => c.name === task.target.name)) shown[0] = task.target;
        const display = this._shuffle(shown);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะฐะนะดะธ <strong>${task.target.name}</strong> ัะฐัะธะบ!</div>
                <div class="tst-color-grid">
                    ${display.map(c => `<button class="tst-color-ball" data-val="${c.name}" style="background:${c.css}" onclick="Testing._onColorAnswer('${c.name}','${task.target.name}',${t0},'${task.block}','${task.id}')"></button>`).join('')}
                </div>
            </div>`;
    },

    _onColorAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-color-ball').forEach(b => {
                if (b.dataset.val === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    // โโ Shapes โโ
    _taskShapes(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const shown = this._shuffle([...task.allShapes]).slice(0, Math.min(6, task.allShapes.length));
        if (!shown.includes(task.target)) shown[0] = task.target;
        const display = this._shuffle(shown);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะฐะนะดะธ <strong>${task.target}</strong>!</div>
                <div class="tst-shape-grid">
                    ${display.map((s, i) => {
                        const color = SHAPE_COLORS[i % SHAPE_COLORS.length];
                        return `<button class="tst-shape-btn" data-val="${s}" style="color:${color}" onclick="Testing._onShapeAnswer('${s}','${task.target}',${t0},'${task.block}','${task.id}')">
                            <svg viewBox="0 0 100 100" width="60" height="60">${SHAPE_SVG[s] || ''}</svg>
                        </button>`;
                    }).join('')}
                </div>
            </div>`;
    },

    _onShapeAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-shape-btn').forEach(b => {
                if (b.dataset.val === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    // โโ 4th Odd One Out โโ
    _taskOddOneOut(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะขัะธ ะบะฐััะธะฝะบะธ ะดััะถะฐั, ะฐ ะพะดะฝะฐ โ ะฝะตั. ะะฐะนะดะธ ะปะธัะฝัั!</div>
                <div class="tst-odd-grid">
                    ${s.items.map((item, i) => `<button class="tst-odd-btn" data-idx="${i}" onclick="Testing._onOddAnswer(${i},${s.odd},${t0},'${task.block}','${task.id}')">${item}</button>`).join('')}
                </div>
            </div>`;
    },

    _onOddAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-odd-btn').forEach(b => {
                if (parseInt(b.dataset.idx) === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    // โโ Sequence โโ
    _taskSequence(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;
        const shuffledIdx = this._shuffle([...s.correct]);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะฐัััะฐะฒั ะฟะพ ะฟะพััะดะบั โ ััะพ ะฑัะปะพ ัะฝะฐัะฐะปะฐ?</div>
                <div class="tst-seq-slots" id="tst-seq-slots"></div>
                <div class="tst-seq-pool" id="tst-seq-pool">
                    ${shuffledIdx.map(idx => `<button class="tst-seq-item" data-idx="${idx}" onclick="Testing._onSeqPick(this)">${s.items[idx]}</button>`).join('')}
                </div>
                <button class="tst-check-btn hidden" id="tst-seq-check" onclick="Testing._onSeqCheck(${t0},'${task.block}','${task.id}')">ะัะพะฒะตัะธัั โ</button>
            </div>`;
        this._seqOrder = [];
        this._seqCorrect = s.correct;
        this._seqItems = s.items;
    },

    _seqOrder: [],
    _seqCorrect: [],
    _seqItems: [],

    _onSeqPick(btn) {
        const idx = parseInt(btn.dataset.idx);
        this._seqOrder.push(idx);
        btn.classList.add('used');
        btn.disabled = true;
        this._playTick();

        const slots = document.getElementById('tst-seq-slots');
        const slot = document.createElement('span');
        slot.className = 'tst-seq-slot-filled';
        slot.textContent = this._seqItems[idx];
        slot.onclick = () => {
            // ะฃะดะฐะปะธัั ะธะท ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ
            const pos = this._seqOrder.indexOf(idx);
            if (pos !== -1) this._seqOrder.splice(pos, 1);
            slot.remove();
            btn.classList.remove('used');
            btn.disabled = false;
            document.getElementById('tst-seq-check').classList.toggle('hidden', this._seqOrder.length < this._seqCorrect.length);
        };
        slots.appendChild(slot);

        document.getElementById('tst-seq-check').classList.toggle('hidden', this._seqOrder.length < this._seqCorrect.length);
    },

    _onSeqCheck(t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        let correctCount = 0;
        for (let i = 0; i < this._seqCorrect.length; i++) {
            if (this._seqOrder[i] === this._seqCorrect[i]) correctCount++;
        }
        const ok = correctCount === this._seqCorrect.length;
        const score = correctCount / this._seqCorrect.length;
        this._taskResults[block].push({
            id, result: ok ? 'correct' : (score >= 0.5 ? 'partial' : 'incorrect'),
            score, time_sec: Math.round(time * 10) / 10
        });
        this._showFeedback(ok, () => this._next());
    },

    // =============================================
    // TASKS โ SPEECH
    // =============================================

    _taskVocabulary(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;
        const shuffledOpts = this._shuffle([...s.options]);
        const typeLabel = s.type === 'antonym' ? '' : s.type === 'define' ? 'ะงัะพ ััะพ ะทะฝะฐัะธั?' : 'ะงัะพ ััะพ?';

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">${typeLabel || 'ะะฐะบ ะฝะฐะทะฒะฐัั ะพะดะฝะธะผ ัะปะพะฒะพะผ?'}</div>
                <div class="tst-vocab-img">${s.img}</div>
                <div class="tst-options tst-options-vertical">
                    ${shuffledOpts.map(o => `<button class="tst-opt-btn tst-opt-wide" data-val="${o}" onclick="Testing._onVocabAnswer('${o.replace(/'/g,"\\'")}','${s.correct.replace(/'/g,"\\'")}',${t0},'${task.block}','${task.id}')">${o}</button>`).join('')}
                </div>
            </div>`;
    },

    _onVocabAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-opt-btn').forEach(b => {
                if (b.dataset.val === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    _taskGrammar(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;
        const shuffledOpts = this._shuffle([...s.options]);

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะฐะบ ะฟัะฐะฒะธะปัะฝะพ?</div>
                <div class="tst-grammar-q">${s.q}</div>
                <div class="tst-options tst-options-vertical">
                    ${shuffledOpts.map(o => `<button class="tst-opt-btn tst-opt-wide" data-val="${o}" onclick="Testing._onVocabAnswer('${o.replace(/'/g,"\\'")}','${s.correct.replace(/'/g,"\\'")}',${t0},'${task.block}','${task.id}')">${o}</button>`).join('')}
                </div>
            </div>`;
    },

    // =============================================
    // TASKS โ VOICE RECORDING
    // =============================================

    // โโ Unique test prefix for audio storage โโ
    _audioPrefix() {
        return `audio_${this._session.date.slice(0,19).replace(/[^0-9]/g,'')}`;
    },

    // โโ Record Word โโ
    _taskRecordWord(task) {
        if (!VoiceRecorder.isSupported()) {
            // ะัะพะฟััะบะฐะตะผ ะตัะปะธ ะฝะตั ะฟะพะดะดะตัะถะบะธ โ ะฝะต ะฒะปะธัะตั ะฝะฐ ัะบะพัะธะฝะณ
            this._taskResults.speech.push({
                id: task.id, result: 'voice_skipped', score: -1,
                time_sec: 0, details: { skipped: 'no_mic_support', type: 'voice' }
            });
            this._next();
            return;
        }
        const el = document.getElementById('testing-content');
        const t0 = Date.now();

        el.innerHTML = `
            <div class="tst-task tst-rec-task">
                <div class="tst-instruction">๐ค ะกะบะฐะถะธ ะฒัะปัั:</div>
                <div class="tst-rec-emoji">${task.emoji}</div>
                <div class="tst-rec-word">${task.word}</div>
                <div class="tst-rec-area" id="tst-rec-area">
                    <div class="tst-rec-status" id="tst-rec-status">ะะฐะถะผะธ ะดะปั ะทะฐะฟะธัะธ</div>
                    <button class="tst-rec-btn" id="tst-rec-start" onclick="Testing._toggleRecording('${task.id}', ${task.maxSec})">
                        <span class="tst-rec-circle"></span>
                    </button>
                    <div class="tst-rec-level" id="tst-rec-level"><div id="tst-rec-level-bar"></div></div>
                    <div class="tst-rec-timer" id="tst-rec-timer"></div>
                </div>
                <div class="tst-rec-controls hidden" id="tst-rec-controls">
                    <button class="tst-rec-play-btn" id="tst-rec-play" onclick="Testing._playRecording()">โถ ะะพัะปััะฐัั</button>
                    <button class="tst-rec-redo-btn" onclick="Testing._toggleRecording('${task.id}', ${task.maxSec})">๐ ะะฐะฝะพะฒะพ</button>
                    <button class="tst-rec-next-btn" onclick="Testing._submitRecording('${task.id}', '${task.word}', ${t0})">ะะฐะปััะต โ</button>
                </div>
                <button class="tst-rec-skip" onclick="Testing._skipRecording('${task.id}', ${t0})">ะัะพะฟัััะธัั ะทะฐะฟะธัั</button>
            </div>`;
    },

    // โโ Record Describe (ะพะฟะธัะธ ะบะฐััะธะฝะบั) โโ
    _taskRecordDescribe(task) {
        if (!VoiceRecorder.isSupported()) {
            this._taskResults.speech.push({
                id: task.id, result: 'voice_skipped', score: -1,
                time_sec: 0, details: { skipped: 'no_mic_support', type: 'voice' }
            });
            this._next();
            return;
        }
        const el = document.getElementById('testing-content');
        const t0 = Date.now();

        el.innerHTML = `
            <div class="tst-task tst-rec-task">
                <div class="tst-instruction">๐ค ะะฐััะบะฐะถะธ, ััะพ ะฒะธะดะธัั:</div>
                <div class="tst-rec-scene">${task.emoji}</div>
                <div class="tst-rec-prompt">${task.prompt}</div>
                <div class="tst-rec-area" id="tst-rec-area">
                    <div class="tst-rec-status" id="tst-rec-status">ะะฐะถะผะธ ะธ ัะฐััะบะฐะถะธ</div>
                    <button class="tst-rec-btn" id="tst-rec-start" onclick="Testing._toggleRecording('${task.id}', ${task.maxSec})">
                        <span class="tst-rec-circle"></span>
                    </button>
                    <div class="tst-rec-level" id="tst-rec-level"><div id="tst-rec-level-bar"></div></div>
                    <div class="tst-rec-timer" id="tst-rec-timer"></div>
                </div>
                <div class="tst-rec-controls hidden" id="tst-rec-controls">
                    <button class="tst-rec-play-btn" id="tst-rec-play" onclick="Testing._playRecording()">โถ ะะพัะปััะฐัั</button>
                    <button class="tst-rec-redo-btn" onclick="Testing._toggleRecording('${task.id}', ${task.maxSec})">๐ ะะฐะฝะพะฒะพ</button>
                    <button class="tst-rec-next-btn" onclick="Testing._submitRecording('${task.id}', 'describe', ${t0})">ะะฐะปััะต โ</button>
                </div>
                <button class="tst-rec-skip" onclick="Testing._skipRecording('${task.id}', ${t0})">ะัะพะฟัััะธัั ะทะฐะฟะธัั</button>
            </div>`;
    },

    // โโ Recording controls โโ
    _recBlob: null,
    _recAudio: null,
    _recTimer: null,
    _isRecording: false,

    _toggleRecording(taskId, maxSec) {
        if (this._isRecording) {
            this._stopRecording();
        } else {
            this._startRecording(taskId, maxSec);
        }
    },

    async _startRecording(taskId, maxSec) {
        const statusEl = document.getElementById('tst-rec-status');
        const timerEl = document.getElementById('tst-rec-timer');
        const controlsEl = document.getElementById('tst-rec-controls');
        const btnEl = document.getElementById('tst-rec-start');
        const levelEl = document.getElementById('tst-rec-level');

        // ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะตะดัะดััะตะต
        if (this._recTimer) { clearInterval(this._recTimer); this._recTimer = null; }
        if (this._recAudio) { this._recAudio.pause(); this._recAudio = null; }
        VoiceRecorder.stopRecording();

        // ะะฐะฟัะฐัะธะฒะฐะตะผ ะผะธะบัะพัะพะฝ
        statusEl.textContent = 'ะะพัััะฟ ะบ ะผะธะบัะพัะพะฝั...';
        const ok = await VoiceRecorder.requestMic();
        if (!ok) {
            statusEl.textContent = 'โ ะะตั ะดะพัััะฟะฐ ะบ ะผะธะบัะพัะพะฝั';
            setTimeout(() => {
                this._record('speech', taskId, true, 0, { skipped: 'mic_denied' });
                this._next();
            }, 1500);
            return;
        }

        // ะกัะฐัััะตะผ ะทะฐะฟะธัั
        controlsEl.classList.add('hidden');
        btnEl.classList.add('tst-rec-recording');
        levelEl.style.display = '';
        statusEl.textContent = 'โ ะะฐะฟะธัั...';

        VoiceRecorder.startRecording((level) => {
            const bar = document.getElementById('tst-rec-level-bar');
            if (bar) bar.style.width = Math.min(level * 100, 100) + '%';
        });
        this._isRecording = true;

        // ะขะฐะนะผะตั
        let sec = 0;
        timerEl.textContent = `0:00 / 0:${String(maxSec).padStart(2,'0')}`;
        this._recTimer = setInterval(async () => {
            sec++;
            timerEl.textContent = `0:${String(sec).padStart(2,'0')} / 0:${String(maxSec).padStart(2,'0')}`;
            if (sec >= maxSec) {
                await this._stopRecording();
            }
        }, 1000);
    },

    async _stopRecording() {
        if (this._recTimer) { clearInterval(this._recTimer); this._recTimer = null; }
        this._isRecording = false;
        const blob = await VoiceRecorder.stopRecording();
        VoiceRecorder.releaseMic();

        this._recBlob = blob;

        const btnEl = document.getElementById('tst-rec-start');
        const statusEl = document.getElementById('tst-rec-status');
        const controlsEl = document.getElementById('tst-rec-controls');
        const levelEl = document.getElementById('tst-rec-level');

        if (btnEl) btnEl.classList.remove('tst-rec-recording');
        if (levelEl) levelEl.style.display = 'none';
        if (statusEl) statusEl.textContent = 'โ ะะฐะฟะธัะฐะฝะพ!';
        if (controlsEl) controlsEl.classList.remove('hidden');
    },

    _playRecording() {
        if (!this._recBlob) return;
        if (this._recAudio) { this._recAudio.pause(); }
        this._recAudio = new Audio(VoiceRecorder.createURL(this._recBlob));
        this._recAudio.play().catch(() => {});
    },

    async _submitRecording(taskId, label, t0) {
        if (this._recAudio) { this._recAudio.pause(); this._recAudio = null; }
        // ะกะพััะฐะฝัะตะผ ะฒ IndexedDB
        if (this._recBlob) {
            const audioId = `${this._audioPrefix()}_${taskId}`;
            try {
                await VoiceRecorder.save(audioId, this._recBlob, { word: label, taskId });
            } catch(e) { console.warn('Audio save failed:', e); }
        }
        // ะะฐะฟะธััะฒะฐะตะผ ะบะฐะบ voice_task โ ะะ ะฒะปะธัะตั ะฝะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ัะบะพัะธะฝะณ
        this._taskResults.speech.push({
            id: taskId,
            result: 'voice',
            score: -1, // sentinel: ะธัะบะปััะธัั ะธะท ะฟะพะดััััะฐ
            time_sec: Math.round((Date.now() - t0) / 1000 * 10) / 10,
            details: { recorded: !!this._recBlob, word: label, type: 'voice' }
        });
        this._recBlob = null;
        this._isRecording = false;
        VoiceRecorder.releaseMic();
        this._next();
    },

    _skipRecording(taskId, t0) {
        if (this._recTimer) { clearInterval(this._recTimer); this._recTimer = null; }
        if (this._recAudio) { this._recAudio.pause(); this._recAudio = null; }
        this._isRecording = false;
        VoiceRecorder.stopRecording();
        VoiceRecorder.releaseMic();
        this._taskResults.speech.push({
            id: taskId,
            result: 'voice_skipped',
            score: -1,
            time_sec: Math.round((Date.now() - t0) / 1000 * 10) / 10,
            details: { skipped: 'user', type: 'voice' }
        });
        this._recBlob = null;
        this._next();
    },

    // โโ Coins (drag speed + accuracy) โโ
    _taskCoins(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const sizes = { '3-4': { coin: 60, target: 100 }, '4-5': { coin: 50, target: 90 }, '5-6': { coin: 42, target: 80 }, '6-7': { coin: 36, target: 70 } };
        const cfg = sizes[task.age] || sizes['4-5'];
        const coinCount = 6;

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะตัะตัะฐัะธ ะฒัะต ะผะพะฝะตัะบะธ ะฒ ะบะพะฟะธะปะบั!</div>
                <div class="tst-coins-area" id="tst-coins-area">
                    <div class="tst-piggy" id="tst-piggy" style="width:${cfg.target}px;height:${cfg.target}px;">๐ท</div>
                </div>
            </div>`;

        const area = document.getElementById('tst-coins-area');
        this._coinsLeft = coinCount;
        this._coinsT0 = Date.now();
        this._coinsMisses = 0;
        this._coinsTask = task;

        // ะะฐะทะผะตัะฐะตะผ ะผะพะฝะตัั ัะปััะฐะนะฝะพ
        setTimeout(() => {
            const aRect = area.getBoundingClientRect();
            for (let i = 0; i < coinCount; i++) {
                const coin = document.createElement('div');
                coin.className = 'tst-coin';
                coin.textContent = '๐ช';
                coin.style.width = cfg.coin + 'px';
                coin.style.height = cfg.coin + 'px';
                coin.style.fontSize = (cfg.coin * 0.6) + 'px';
                // Random position avoiding piggy center
                let x, y;
                do {
                    x = Math.random() * (aRect.width - cfg.coin);
                    y = Math.random() * (aRect.height - cfg.coin);
                } while (Math.abs(x - aRect.width / 2) < cfg.target && Math.abs(y - aRect.height / 2) < cfg.target);
                coin.style.left = x + 'px';
                coin.style.top = y + 'px';
                this._makeDraggable(coin, cfg);
                area.appendChild(coin);
            }
        }, 100);
    },

    _makeDraggable(coin, cfg) {
        let startX, startY, origLeft, origTop;
        const onStart = (e) => {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            origLeft = parseFloat(coin.style.left);
            origTop = parseFloat(coin.style.top);
            coin.style.zIndex = 10;
            coin.style.transform = 'scale(1.15)';
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', onEnd);
        };
        const onMove = (e) => {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const dx = touch.clientX - startX;
            const dy = touch.clientY - startY;
            // Constrain to area bounds
            const area = document.getElementById('tst-coins-area');
            if (area) {
                const aRect = area.getBoundingClientRect();
                const cw = parseFloat(coin.style.width) || 50;
                const ch = parseFloat(coin.style.height) || 50;
                const newLeft = Math.max(0, Math.min(aRect.width - cw, origLeft + dx));
                const newTop = Math.max(0, Math.min(aRect.height - ch, origTop + dy));
                coin.style.left = newLeft + 'px';
                coin.style.top = newTop + 'px';
            } else {
                coin.style.left = (origLeft + dx) + 'px';
                coin.style.top = (origTop + dy) + 'px';
            }
        };
        const onEnd = (e) => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
            coin.style.zIndex = '';
            coin.style.transform = '';

            // ะัะพะฒะตััะตะผ ะฟะพะฟะฐะดะฐะฝะธะต ะฒ ะบะพะฟะธะปะบั
            const piggy = document.getElementById('tst-piggy');
            if (piggy) {
                const pRect = piggy.getBoundingClientRect();
                const cRect = coin.getBoundingClientRect();
                const cx = cRect.left + cRect.width / 2;
                const cy = cRect.top + cRect.height / 2;
                if (cx >= pRect.left && cx <= pRect.right && cy >= pRect.top && cy <= pRect.bottom) {
                    Testing._playTick();
                    coin.style.transition = 'transform 0.2s, opacity 0.2s';
                    coin.style.transform = 'scale(0)';
                    coin.style.opacity = '0';
                    setTimeout(() => coin.remove(), 200);
                    Testing._coinsLeft--;
                    if (Testing._coinsLeft <= 0) {
                        const time = (Date.now() - Testing._coinsT0) / 1000;
                        const timeLimits = { '3-4': 20, '4-5': 15, '5-6': 12, '6-7': 10 };
                        const limit = timeLimits[Testing._coinsTask.age] || 15;
                        const ok = time <= limit * 1.5; // ะดะฐัะผ ะฟะพะปัะพัะฐ ะฝะพัะผะฐัะธะฒะฐ
                        const score = Math.max(0, Math.min(1, 1 - (time - limit) / (limit * 2)));
                        Testing._taskResults.motor.push({
                            id: Testing._coinsTask.id,
                            result: ok ? 'correct' : 'partial',
                            score: Math.round(score * 100) / 100,
                            time_sec: Math.round(time * 10) / 10,
                            details: { misses: Testing._coinsMisses }
                        });
                        Testing._showFeedback(ok, () => Testing._next());
                    }
                    return;
                }
            }
            Testing._coinsMisses++;
        };
        coin.addEventListener('mousedown', onStart);
        coin.addEventListener('touchstart', onStart, { passive: false });
    },

    // โโ Dots (copy pattern) โโ
    _taskDots(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const gridPool = {
            '3-4': [
                { size: 3, dots: [[0,0],[1,0],[2,0]] },
                { size: 3, dots: [[1,0],[0,1],[2,1]] },
                { size: 3, dots: [[0,0],[2,0],[1,2]] },
                { size: 3, dots: [[1,1],[0,2],[2,2]] }
            ],
            '4-5': [
                { size: 4, dots: [[1,0],[0,1],[2,1],[1,2],[1,1]] },
                { size: 4, dots: [[0,0],[3,0],[0,3],[3,3],[1,1]] },
                { size: 4, dots: [[2,0],[1,1],[3,1],[0,2],[2,2]] },
                { size: 4, dots: [[0,0],[2,0],[1,1],[3,1],[2,2]] }
            ],
            '5-6': [
                { size: 5, dots: [[2,0],[0,2],[4,2],[1,4],[3,4],[2,2],[2,4]] },
                { size: 5, dots: [[1,0],[3,0],[0,2],[4,2],[2,2],[1,4],[3,4]] },
                { size: 5, dots: [[2,0],[0,1],[4,1],[2,2],[1,3],[3,3],[2,4]] },
                { size: 5, dots: [[0,0],[4,0],[2,1],[1,3],[3,3],[0,4],[4,4]] }
            ],
            '6-7': [
                { size: 5, dots: [[2,0],[0,1],[4,1],[0,3],[4,3],[1,4],[2,4],[3,4],[2,2]] },
                { size: 5, dots: [[1,0],[3,0],[0,1],[4,1],[2,2],[0,3],[4,3],[2,4]] },
                { size: 5, dots: [[0,0],[2,0],[4,0],[1,1],[3,1],[2,2],[1,3],[3,3],[2,4]] },
                { size: 5, dots: [[2,0],[0,1],[4,1],[1,2],[3,2],[0,3],[4,3],[2,4]] }
            ]
        };
        const pool = gridPool[task.age] || gridPool['4-5'];
        const cfg = pool[this._rand(0, pool.length - 1)];
        this._dotsTarget = new Set(cfg.dots.map(d => d[0]+','+d[1]));
        this._dotsPlaced = new Set();
        this._dotsSize = cfg.size;
        this._dotsT0 = t0;
        this._dotsTask = task;

        const cellSize = Math.min(56, Math.floor(240 / cfg.size));

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะพััะฐะฒั ัะพัะบะธ ะบะฐะบ ะฝะฐ ะพะฑัะฐะทัะต!</div>
                <div class="tst-dots-wrap">
                    <div class="tst-dots-panel">
                        <div class="tst-dots-label">ะะฑัะฐะทะตั</div>
                        <div class="tst-dots-grid" style="grid-template-columns:repeat(${cfg.size},${cellSize}px)">
                            ${this._renderDotsGrid(cfg.size, cfg.dots, cellSize, false)}
                        </div>
                    </div>
                    <div class="tst-dots-panel">
                        <div class="tst-dots-label">ะขะฒะพะน ะพัะฒะตั</div>
                        <div class="tst-dots-grid" style="grid-template-columns:repeat(${cfg.size},${cellSize}px)" id="tst-dots-answer">
                            ${this._renderDotsGrid(cfg.size, [], cellSize, true)}
                        </div>
                    </div>
                </div>
                <button class="tst-check-btn" id="tst-dots-check" onclick="Testing._onDotsCheck()">ะัะพะฒะตัะธัั โ</button>
            </div>`;
    },

    _renderDotsGrid(size, dots, cellSize, interactive) {
        const dotSet = new Set(dots.map(d => d[0]+','+d[1]));
        let html = '';
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const hasDot = dotSet.has(x+','+y);
                if (interactive) {
                    html += `<div class="tst-dot-cell" style="width:${cellSize}px;height:${cellSize}px" data-x="${x}" data-y="${y}" onclick="Testing._toggleDot(this)">
                        <span class="tst-dot-mark"></span></div>`;
                } else {
                    html += `<div class="tst-dot-cell tst-dot-sample" style="width:${cellSize}px;height:${cellSize}px">
                        ${hasDot ? '<span class="tst-dot-mark active"></span>' : '<span class="tst-dot-mark"></span>'}</div>`;
                }
            }
        }
        return html;
    },

    _toggleDot(cell) {
        this._playTick();
        const x = cell.dataset.x, y = cell.dataset.y;
        const key = x+','+y;
        const mark = cell.querySelector('.tst-dot-mark');
        if (this._dotsPlaced.has(key)) {
            this._dotsPlaced.delete(key);
            mark.classList.remove('active');
        } else {
            this._dotsPlaced.add(key);
            mark.classList.add('active');
        }
    },

    _onDotsCheck() {
        const time = (Date.now() - this._dotsT0) / 1000;
        let correct = 0;
        for (const key of this._dotsTarget) {
            if (this._dotsPlaced.has(key)) correct++;
        }
        // ะจััะฐั ะทะฐ ะปะธัะฝะธะต ัะพัะบะธ
        let extra = 0;
        for (const key of this._dotsPlaced) {
            if (!this._dotsTarget.has(key)) extra++;
        }
        const score = Math.max(0, (correct - extra * 0.5) / this._dotsTarget.size);
        const ok = score >= 0.7;
        this._taskResults.motor.push({
            id: this._dotsTask.id,
            result: ok ? 'correct' : (score >= 0.4 ? 'partial' : 'incorrect'),
            score: Math.round(score * 100) / 100,
            time_sec: Math.round(time * 10) / 10,
            details: { correct, extra, total: this._dotsTarget.size }
        });
        this._showFeedback(ok, () => this._next());
    },

    // =============================================
    // TASKS โ SOCIAL
    // =============================================

    _taskEmotions(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;
        const emojiMap = { 'ะะฐะดะพััั': '๐', 'ะััััั': '๐ข', 'ะะปะพััั': '๐', 'ะกััะฐั': '๐จ', 'ะกััะด': '๐ณ', 'ะฃะดะธะฒะปะตะฝะธะต': '๐ฒ' };

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะงัะพ ััะฒััะฒัะตั ัะตะฑัะฝะพะบ?</div>
                <div class="tst-scene">${s.scene}</div>
                <div class="tst-scene-desc">${s.desc}</div>
                <div class="tst-emo-options">
                    ${s.options.map(o => `<button class="tst-emo-btn" data-val="${o}" onclick="Testing._onEmoAnswer('${o}','${s.correct}',${t0},'${task.block}','${task.id}')">
                        <span class="tst-emo-icon">${emojiMap[o] || 'โ'}</span>
                        <span class="tst-emo-label">${o}</span>
                    </button>`).join('')}
                </div>
            </div>`;
    },

    _onEmoAnswer(selected, correct, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === correct;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-emo-btn').forEach(b => {
                if (b.dataset.val === correct) b.classList.add('tst-highlight-correct');
            });
        });
    },

    _taskSituations(task) {
        const el = document.getElementById('testing-content');
        const t0 = Date.now();
        const s = task.set;

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะะฐะบ ัั ะดัะผะฐะตัั, ััะพ ะฝัะถะฝะพ ัะดะตะปะฐัั?</div>
                <div class="tst-situation-desc">${s.desc}</div>
                <div class="tst-options tst-options-vertical">
                    ${s.options.map((o, i) => `<button class="tst-opt-btn tst-opt-wide" data-idx="${i}" onclick="Testing._onSitAnswer(${i},${s.prosocial},${t0},'${task.block}','${task.id}')">${o}</button>`).join('')}
                </div>
            </div>`;
    },

    _onSitAnswer(selected, prosocial, t0, block, id) {
        const time = (Date.now() - t0) / 1000;
        const ok = selected === prosocial;
        this._record(block, id, ok, time);
        this._showFeedback(ok, () => this._next(), ok ? null : () => {
            document.querySelectorAll('.tst-opt-btn').forEach(b => {
                if (parseInt(b.dataset.idx) === prosocial) b.classList.add('tst-highlight-correct');
            });
        });
    },

    // โโ Self-Care Checklist โโ
    _taskSelfCare(task) {
        const el = document.getElementById('testing-content');
        const items = TESTING_TASKS.social.selfCare[task.age] || TESTING_TASKS.social.selfCare['4-5'];
        this._selfCareItems = items;
        this._selfCareChecked = new Set();
        this._selfCareTask = task;

        el.innerHTML = `
            
            <div class="tst-task">
                <div class="tst-instruction">ะงัะพ ัั ัะถะต ัะผะตะตัั ะดะตะปะฐัั ัะฐะผ? ะะฐะถะผะธ!</div>
                <div class="tst-parent-hint">๐จโ๐ฉโ๐ง ะะพะดะธัะตะปั: ะฟะพะผะพะณะธัะต ะพัะผะตัะธัั ะฝะฐะฒัะบะธ ัะตะฑัะฝะบะฐ</div>
                <div class="tst-selfcare-grid" id="tst-selfcare-grid">
                    ${items.map((item, i) => `<button class="tst-selfcare-btn" data-idx="${i}" onclick="Testing._toggleSelfCare(this,${i})">${item}</button>`).join('')}
                </div>
                <button class="tst-check-btn" onclick="Testing._onSelfCareCheck()">ะะพัะพะฒะพ โ</button>
            </div>`;
    },

    _toggleSelfCare(btn, idx) {
        this._playTick();
        if (this._selfCareChecked.has(idx)) {
            this._selfCareChecked.delete(idx);
            btn.classList.remove('checked');
        } else {
            this._selfCareChecked.add(idx);
            btn.classList.add('checked');
        }
    },

    _onSelfCareCheck() {
        const total = this._selfCareItems.length;
        const checked = this._selfCareChecked.size;
        const score = total ? checked / total : 0;
        this._taskResults.social.push({
            id: this._selfCareTask.id,
            result: 'self-report',
            score: Math.round(score * 100) / 100,
            time_sec: 0,
            details: { checked, total, items: [...this._selfCareChecked].map(i => this._selfCareItems[i]) }
        });
        this._next();
    },

    // =============================================
    // FINISH โ ัะตะทัะปััะฐัั
    // =============================================
    _showFinish() {
        this._hideProgress();
        const duration = Math.round((Date.now() - this._startTime) / 1000);

        // ะะพะดัััั ะฟะพ ะฑะปะพะบะฐะผ (voice tasks ั score=-1 ะธัะบะปััะตะฝั ะธะท ะฐะฒัะพัะบะพัะธะฝะณะฐ)
        const blocks = {};
        for (const [block, tasks] of Object.entries(this._taskResults)) {
            if (tasks.length === 0) continue;
            const autoTasks = tasks.filter(t => t.score >= 0);
            const voiceTasks = tasks.filter(t => t.score < 0);
            if (autoTasks.length === 0 && voiceTasks.length > 0) {
                // ะขะพะปัะบะพ ะณะพะปะพัะพะฒัะต ะทะฐะดะฐะฝะธั โ ะฝะต ะดะฐัะผ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฑะฐะปะป
                blocks[block] = { score: null, tasks, voiceOnly: true };
                continue;
            }
            if (autoTasks.length === 0) continue;
            const sum = autoTasks.reduce((s, t) => s + t.score, 0);
            blocks[block] = {
                score: Math.round(sum / autoTasks.length * 100) / 100,
                tasks,
                autoCount: autoTasks.length,
                voiceCount: voiceTasks.length,
                avgTime: Math.round(autoTasks.reduce((s, t) => s + t.time_sec, 0) / autoTasks.length * 10) / 10
            };
        }

        // ะะฟัะตะดะตะปัะตะผ ัะธะปัะฝัะต/ัะปะฐะฑัะต ััะพัะพะฝั
        const blockEntries = Object.entries(blocks);
        let strongest = '', weakest = '';
        if (blockEntries.length) {
            blockEntries.sort((a, b) => b[1].score - a[1].score);
            strongest = blockEntries[0][0];
            weakest = blockEntries[blockEntries.length - 1][0];
        }

        // ะกะพััะฐะฝัะตะผ ัะตะทัะปััะฐั
        const result = {
            id: `${this._session.type}_${new Date().toISOString().slice(0,10)}`,
            type: this._session.type,
            date: this._session.date,
            age_group: this._session.age_group,
            duration_sec: duration,
            blocks,
            miniBlock: this._session.miniBlock || null,
            audioPrefix: this._audioPrefix(),
            summary: { strongest, weakest }
        };
        this._results.push(result);
        this._saveResults();

        // Confetti + fanfare!
        this._playFinishFanfare();
        if (typeof confetti === 'function') {
            confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
        }

        // ะัะพะฑัะฐะถะฐะตะผ ัะตะทัะปััะฐั
        const el = document.getElementById('testing-content');
        const avg = this._avgScore(result);
        const blockNames = { cognitive: '๐ง ะะพะณะฝะธัะธั', speech: '๐ฌ ะะตัั', motor: 'โ ะะพัะพัะธะบะฐ', social: 'โค๏ธ ะกะพัะธัะผ' };

        let blocksHtml = '';
        for (const [b, data] of Object.entries(blocks)) {
            if (data.voiceOnly) {
                blocksHtml += `
                    <div class="tst-result-block">
                        <div class="tst-rb-header">
                            <span>${blockNames[b] || b}</span>
                            <span style="color:var(--text2);font-size:12px">๐ ะขะพะปัะบะพ ะณะพะปะพั</span>
                        </div>
                        <div class="tst-rb-label" style="color:var(--text2)">ะัะพัะปััะฐะนัะต ะทะฐะฟะธัะธ ะฒ ยซะะตัะตะฒะพะผ ะฟะพัััะตัะตยป</div>
                    </div>`;
                continue;
            }
            const pct = Math.round(data.score * 100);
            const color = this._scoreColor(data.score);
            const label = this._scoreLabel(data.score);
            const timeInfo = data.avgTime ? ` ยท ~${data.avgTime}ั ะฝะฐ ะทะฐะดะฐะฝะธะต` : '';
            blocksHtml += `
                <div class="tst-result-block">
                    <div class="tst-rb-header">
                        <span>${blockNames[b] || b}</span>
                        <span style="color:${color};font-weight:600">${pct}%</span>
                    </div>
                    <div class="tst-rb-bar"><div class="tst-rb-fill" style="width:${pct}%;background:${color}"></div></div>
                    <div class="tst-rb-label" style="color:${color}">${label}${timeInfo}</div>
                </div>`;
        }

        // ะะตะบะพะผะตะฝะดะฐัะธะธ โ ะฒัะตะณะดะฐ ะฟะพะบะฐะทัะฒะฐะตะผ, ั ะบะพะฝะบัะตัะฝัะผะธ ัะฟัะฐะถะฝะตะฝะธัะผะธ
        let recsHtml = '<div class="tst-recs-title">ะงะตะผ ะทะฐะฝััััั</div><div class="tst-recs">';
        let hasRecs = false;

        if (blocks.cognitive && blocks.cognitive.score != null) {
            if (blocks.cognitive.score < 0.4) {
                recsHtml += '<div class="tst-rec">๐งฉ <strong>ะกััั ะธ ะปะพะณะธะบะฐ:</strong> ะกัะธัะฐะนัะต ัััะฟะตะฝัะบะธ, ะปะพะถะบะธ ะทะฐ ััะพะปะพะผ, ะผะฐัะธะฝั ะฝะฐ ะฟัะพะณัะปะบะต. ะะณัะฐะนัะต ะฒ ยซััะพ ะปะธัะฝะตะต?ยป ั ัะตะฐะปัะฝัะผะธ ะฟัะตะดะผะตัะฐะผะธ. ะกะพะฑะธัะฐะนัะต ะฟะฐะทะปั ะธะท 6โ12 ัะฐััะตะน.</div>';
                hasRecs = true;
            } else if (blocks.cognitive.score < 0.6) {
                recsHtml += '<div class="tst-rec">๐งฉ <strong>ะกััั ะธ ะปะพะณะธะบะฐ:</strong> ะกะพััะธััะนัะต ะฟัะตะดะผะตัั ะฟะพ ัะฒะตัั ะธ ัะพัะผะต. ะะณัะฐะนัะต ะฒ ะฝะฐััะพะปัะฝัะต ะธะณัั ั ะบัะฑะธะบะพะผ (ััะธัะฐัั ัะพะดั). ะกััะพะนัะต ะธะท ะบัะฑะธะบะพะฒ ะฟะพ ะพะฑัะฐะทัั.</div>';
                hasRecs = true;
            }
        }
        if (blocks.speech && blocks.speech.score != null) {
            if (blocks.speech.score < 0.4) {
                recsHtml += '<div class="tst-rec">๐ <strong>ะะตัั ะธ ัะปะพะฒะฐ:</strong> ะงะธัะฐะนัะต ะฒัะปัั ะบะฐะถะดัะน ะดะตะฝั 10โ15 ะผะธะฝัั. ะะฐะดะฐะฒะฐะนัะต ะฒะพะฟัะพัั ะฟะพ ะบะฐััะธะฝะบะฐะผ: ยซะงัะพ ะดะตะปะฐะตั ะผะฐะปััะธะบ? ะะพัะตะผั?ยป. ะะณัะฐะนัะต ะฒ ยซะฝะฐะทะพะฒะธ ะพะดะฝะธะผ ัะปะพะฒะพะผยป (ัะฑะปะพะบะพ, ะณัััะฐ, ะฑะฐะฝะฐะฝ โ ัััะบัั).</div>';
                hasRecs = true;
            } else if (blocks.speech.score < 0.6) {
                recsHtml += '<div class="tst-rec">๐ <strong>ะะตัั ะธ ัะปะพะฒะฐ:</strong> ะัะพัะธัะต ัะตะฑัะฝะบะฐ ะฟะตัะตัะบะฐะทัะฒะฐัั ัะบะฐะทะบะธ. ะะณัะฐะนัะต ะฒ ัะธัะผั ะธ ะฐะฝัะพะฝะธะผั (ะฑะพะปััะพะน โ ะผะฐะปะตะฝัะบะธะน). ะะฟะธััะฒะฐะนัะต ะฒะผะตััะต ะบะฐััะธะฝะบะธ ะฒ ะบะฝะธะณะฐั.</div>';
                hasRecs = true;
            }
        }
        if (blocks.motor && blocks.motor.score != null) {
            if (blocks.motor.score < 0.4) {
                recsHtml += '<div class="tst-rec">โ๏ธ <strong>ะะตะปะบะฐั ะผะพัะพัะธะบะฐ:</strong> ะะตะฟะธัะต ะธะท ะฟะปะฐััะธะปะธะฝะฐ ัะธะณััะบะธ. ะะฐะฝะธะทัะฒะฐะนัะต ะฑััะธะฝั ะฝะฐ ัะฝััะพะบ. ะะฒะธัะต ะฑัะผะฐะณั ะฝะฐ ะผะตะปะบะธะต ะบััะพัะบะธ ะธ ะดะตะปะฐะนัะต ะฐะฟะฟะปะธะบะฐัะธะธ. ะะธััะนัะต ะฟะฐะปััะธะบะพะฒัะผะธ ะบัะฐัะบะฐะผะธ.</div>';
                hasRecs = true;
            } else if (blocks.motor.score < 0.6) {
                recsHtml += '<div class="tst-rec">โ๏ธ <strong>ะะตะปะบะฐั ะผะพัะพัะธะบะฐ:</strong> ะััะตะทะฐะนัะต ะฝะพะถะฝะธัะฐะผะธ ะฟัะพัััะต ัะธะณััั. ะะฑะฒะพะดะธัะต ััะฐัะฐัะตัั. ะะฐัััะณะธะฒะฐะนัะต ะฟัะณะพะฒะธัั ะธ ะผะพะปะฝะธะธ. ะกะพะฑะธัะฐะนัะต ะผะพะทะฐะธะบั.</div>';
                hasRecs = true;
            }
        }
        if (blocks.social && blocks.social.score != null) {
            if (blocks.social.score < 0.4) {
                recsHtml += '<div class="tst-rec">๐ญ <strong>ะญะผะพัะธะธ ะธ ะพะฑัะตะฝะธะต:</strong> ะะฐะทัะฒะฐะนัะต ัะผะพัะธะธ: ยซะขั ัะตะนัะฐั ะทะปะธัััั, ะฟะพัะพะผั ััะพ...ยป. ะะณัะฐะนัะต ะฒ ัะพะปะตะฒัะต ะธะณัั (ะผะฐะณะฐะทะธะฝ, ะฑะพะปัะฝะธัะฐ, ัะบะพะปะฐ). ะะฑััะถะดะฐะนัะต ััะฒััะฒะฐ ะณะตัะพะตะฒ ะผัะปัััะธะปัะผะพะฒ ะธ ัะบะฐะทะพะบ.</div>';
                hasRecs = true;
            } else if (blocks.social.score < 0.6) {
                recsHtml += '<div class="tst-rec">๐ญ <strong>ะญะผะพัะธะธ ะธ ะพะฑัะตะฝะธะต:</strong> ะะณัะฐะนัะต ะฒ ยซะฟะพะบะฐะถะธ ัะผะพัะธัยป ะฟะตัะตะด ะทะตัะบะฐะปะพะผ. ะะฐะทะฑะธัะฐะนัะต ัะธััะฐัะธะธ: ยซะ ะบะฐะบ ะฑั ัั ะฟะพัััะฟะธะป?ยป. ะฅะฒะฐะปะธัะต ะทะฐ ะฟัะพัะฒะปะตะฝะธะต ะทะฐะฑะพัั ะพ ะดััะณะธั.</div>';
                hasRecs = true;
            }
        }

        // ะัะปะธ ะฒัั ัะพัะพัะพ โ ะฟะพัะฒะฐะปะฐ
        if (!hasRecs) {
            recsHtml += '<div class="tst-rec">๐ ะัะปะธัะฝัะต ัะตะทัะปััะฐัั! ะัะพะดะพะปะถะฐะนัะต ะฒ ัะพะผ ะถะต ะดััะต โ ะธะณัะฐะนัะต, ัะธัะฐะนัะต ะธ ะฟะพะทะฝะฐะฒะฐะนัะต ะผะธั ะฒะผะตััะต.</div>';
        }
        recsHtml += '</div>';

        // ะะตัะตะฒะพะน ะฟะพัััะตั โ ะตัะปะธ ะฑัะปะธ ะทะฐะฟะธัะธ
        let voiceHtml = '';
        const audioPrefix = this._audioPrefix();
        VoiceRecorder.getAllForTest(audioPrefix).then(recordings => {
            if (!recordings.length) return;
            const container = document.getElementById('tst-voice-portrait');
            if (!container) return;
            let html = '<div class="tst-voice-title">๐ ะะตัะตะฒะพะน ะฟะพัััะตั</div><div class="tst-voice-list">';
            recordings.forEach((rec, i) => {
                const label = rec.meta?.word || 'ะะฐะฟะธัั';
                html += `<div class="tst-voice-item">
                    <button class="tst-voice-play" onclick="Testing._playVoiceItem(this, '${rec.id}')">โถ</button>
                    <span class="tst-voice-item-label">${label === 'describe' ? '๐ ะะฟะธัะฐะฝะธะต ะบะฐััะธะฝะบะธ' : '๐ฃ ยซ' + label + 'ยป'}</span>
                </div>`;
            });
            html += '</div>';

            // ะงะตะบะปะธัั ะฟัะพะธะทะฝะพัะตะฝะธั โ ะดะปั ัะพะดะธัะตะปั
            const sounds = ['ะ','ะจ','ะ','ะฉ','ะง','ะฆ','ะ','ะก','ะ'];
            html += `<div class="tst-pron-section">
                <div class="tst-pron-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="tst-pron-header-text">๐จโ๐ฉโ๐ง ะัะตะฝะบะฐ ะฟัะพะธะทะฝะพัะตะฝะธั</span>
                    <span class="tst-pron-header-tag">ะฝะตะพะฑัะทะฐัะตะปัะฝะพ</span>
                    <span class="tst-pron-header-arrow">โบ</span>
                </div>
                <div class="tst-pron-body">
                    <div class="tst-pron-explain">ะัะพัะปััะฐะนัะต ะทะฐะฟะธัะธ ะฒััะต ะธ ะพัะผะตัััะต ะทะฒัะบะธ:<br>ะบะฐะบ ัะตะฑัะฝะพะบ ะธั ะฟัะพะธะทะฝะพัะธั.</div>
                    <div class="tst-pron-table">`;
            sounds.forEach(s => {
                const savedState = this._getPronState(audioPrefix, s);
                html += `<div class="tst-pron-row-item">
                    <span class="tst-pron-sound">${s}</span>
                    <button class="tst-pron-opt ${savedState === 'ok' ? 'active' : ''}" data-state="ok" onclick="Testing._setPron(this, '${audioPrefix}', '${s}', 'ok')">โ ัะธััะพ</button>
                    <button class="tst-pron-opt ${savedState === 'issue' ? 'active' : ''}" data-state="issue" onclick="Testing._setPron(this, '${audioPrefix}', '${s}', 'issue')">โ๏ธ ะทะฐะผะตะฝะฐ</button>
                </div>`;
            });
            html += `</div>
                </div>
            </div>`;

            container.innerHTML = html;
        }).catch(() => {});

        el.innerHTML = `
            <div class="tst-finish">
                <div class="tst-finish-emoji">๐</div>
                <div class="tst-finish-title">ะขะตัั ะฟัะพะนะดะตะฝ!</div>
                <div class="tst-finish-stars">${'โญ'.repeat(Math.min(this._starsCollected || 0, 15))}</div>
                <div class="tst-finish-time">ะัะตะผั: ${Math.floor(duration / 60)}:${String(duration % 60).padStart(2, '0')}</div>
                <div class="tst-finish-avg" style="color:${this._scoreColor(avg)}">ะะฑัะธะน ัะตะทัะปััะฐั: ${Math.round(avg * 100)}%</div>
                <div class="tst-result-blocks">${blocksHtml}</div>
                <div id="tst-voice-portrait"></div>
                ${recsHtml}
                <button class="tst-start-btn" onclick="Testing._showDashboard()">ะะฐ ะณะปะฐะฒะฝัั โ</button>
            </div>`;
    },

    // โโ Voice playback helpers โโ
    _voiceAudio: null,
    async _playVoiceItem(btn, id) {
        if (this._voiceAudio) { this._voiceAudio.pause(); this._voiceAudio = null; }
        // Reset all play buttons
        document.querySelectorAll('.tst-voice-play').forEach(b => { b.textContent = 'โถ'; });
        try {
            const rec = await VoiceRecorder.get(id);
            if (!rec || !rec.blob) return;
            this._voiceAudio = new Audio(VoiceRecorder.createURL(rec.blob));
            btn.textContent = 'โธ';
            this._voiceAudio.onended = () => { btn.textContent = 'โถ'; };
            this._voiceAudio.play().catch(() => {});
        } catch(e) {}
    },

    // โโ Load audio for history accordion โโ
    async _loadHistAudio(prefix, ri) {
        const wrap = document.getElementById(`tst-hist-audio-${ri}`);
        if (!wrap) return;
        try {
            const recordings = await VoiceRecorder.getAllForTest(prefix);
            if (!recordings.length) {
                wrap.innerHTML = '<div class="tst-hist-audio-empty">ะะฐะฟะธัะธ ะฝะต ะฝะฐะนะดะตะฝั</div>';
                return;
            }

            let html = '<div class="tst-hist-audio-list">';
            recordings.forEach(rec => {
                const label = rec.meta?.word || 'ะะฐะฟะธัั';
                const display = label === 'describe' ? '๐ ะะฟะธัะฐะฝะธะต' : `๐ฃ ${label}`;
                html += `<div class="tst-hist-audio-item">
                    <button class="tst-voice-play" onclick="Testing._playVoiceItem(this, '${rec.id}')">โถ</button>
                    <span>${display}</span>
                </div>`;
            });

            // ะงะตะบะปะธัั ะฟัะพะธะทะฝะพัะตะฝะธั โ ะดะปั ัะพะดะธัะตะปั
            const sounds = ['ะ','ะจ','ะ','ะฉ','ะง','ะฆ','ะ','ะก','ะ'];
            html += `<div class="tst-pron-section tst-pron-compact">
                <div class="tst-pron-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="tst-pron-header-text">๐จโ๐ฉโ๐ง ะัะพะธะทะฝะพัะตะฝะธะต</span>
                    <span class="tst-pron-header-tag">ะฝะตะพะฑัะทะฐัะตะปัะฝะพ</span>
                    <span class="tst-pron-header-arrow">โบ</span>
                </div>
                <div class="tst-pron-body">
                    <div class="tst-pron-explain">ะัะพัะปััะฐะนัะต ะทะฐะฟะธัะธ ะธ ะพัะผะตัััะต ะทะฒัะบะธ.</div>
                    <div class="tst-pron-table">`;
            sounds.forEach(s => {
                const state = this._getPronState(prefix, s);
                html += `<div class="tst-pron-row-item">
                    <span class="tst-pron-sound">${s}</span>
                    <button class="tst-pron-opt ${state === 'ok' ? 'active' : ''}" data-state="ok" onclick="Testing._setPron(this, '${prefix}', '${s}', 'ok')">โ</button>
                    <button class="tst-pron-opt ${state === 'issue' ? 'active' : ''}" data-state="issue" onclick="Testing._setPron(this, '${prefix}', '${s}', 'issue')">โ๏ธ</button>
                </div>`;
            });
            html += `</div>
                </div>
            </div>`;
            html += '</div>';

            wrap.innerHTML = html;
        } catch(e) {
            wrap.innerHTML = '<div class="tst-hist-audio-empty">ะัะธะฑะบะฐ ะทะฐะณััะทะบะธ</div>';
        }
    },

    // โโ Pronunciation checklist โโ
    _getPronState(prefix, sound) {
        try {
            const data = JSON.parse(localStorage.getItem('testing_pron') || '{}');
            return (data[prefix] && data[prefix][sound]) || '';
        } catch(e) { return ''; }
    },

    _setPron(btn, prefix, sound, state) {
        let data;
        try { data = JSON.parse(localStorage.getItem('testing_pron') || '{}'); } catch(e) { data = {}; }
        if (!data[prefix]) data[prefix] = {};

        const current = data[prefix][sound] || '';
        // Toggle off if same state clicked again
        const next = current === state ? '' : state;
        data[prefix][sound] = next;
        try { localStorage.setItem('testing_pron', JSON.stringify(data)); } catch(e) {}

        // Update UI: deactivate sibling, activate this one (or deactivate if toggled off)
        const row = btn.closest('.tst-pron-row-item');
        if (row) {
            row.querySelectorAll('.tst-pron-opt').forEach(b => b.classList.remove('active'));
            if (next) btn.classList.add('active');
        }
        this._playTick();
    },

    _scoreLabel(score) {
        if (score >= 0.8) return 'ะฃะฒะตัะตะฝะฝะพะต ะฒะปะฐะดะตะฝะธะต';
        if (score >= 0.6) return 'ะคะพัะผะธััะตััั';
        if (score >= 0.4) return 'ะขัะตะฑัะตั ะฒะฝะธะผะฐะฝะธั';
        return 'ะัะถะฝะฐ ะฟัะฐะบัะธะบะฐ';
    },

    _blockTip(block, score) {
        if (score >= 0.8) {
            const praise = {
                cognitive: '๐ก ะัะปะธัะฝะพ ััะธัะฐะตั, ัะฐะทะปะธัะฐะตั ัะพัะผั ะธ ะฝะฐัะพะดะธั ะทะฐะบะพะฝะพะผะตัะฝะพััะธ',
                speech:    '๐ก ะฅะพัะพัะธะน ัะปะพะฒะฐัะฝัะน ะทะฐะฟะฐั, ัะฒะตัะตะฝะฝะพ ะฟะพะดะฑะธัะฐะตั ัะปะพะฒะฐ',
                motor:     '๐ก ะะพะฒะบะธะต ะฟะฐะปััะธะบะธ, ัะพัะพัะฐั ะบะพะพัะดะธะฝะฐัะธั',
                social:    '๐ก ะฅะพัะพัะพ ะฟะพะฝะธะผะฐะตั ัะผะพัะธะธ ะธ ะทะฝะฐะตั ะฟัะฐะฒะธะปะฐ ะฟะพะฒะตะดะตะฝะธั'
            };
            return praise[block] || '';
        }
        if (score >= 0.6) {
            const tips = {
                cognitive: 'โ ะกัะธัะฐะนัะต ะฟัะตะดะผะตัั ะฝะฐ ะฟัะพะณัะปะบะต, ะธะณัะฐะนัะต ะฒ ยซะฝะฐะนะดะธ ะพัะปะธัะธัยป',
                speech:    'โ ะงะธัะฐะนัะต ะฒะผะตััะต ะธ ะฟัะพัะธัะต ะฝะฐะทะฒะฐัั ะฟัะตะดะผะตัั ะฝะฐ ะบะฐััะธะฝะบะฐั',
                motor:     'โ ะะธััะนัะต, ะปะตะฟะธัะต ะธะท ะฟะปะฐััะธะปะธะฝะฐ, ัะพะฑะธัะฐะนัะต ะผะพะทะฐะธะบั',
                social:    'โ ะะฑััะถะดะฐะนัะต ััะฒััะฒะฐ ะณะตัะพะตะฒ ะฒ ะผัะปัััะธะปัะผะฐั ะธ ะบะฝะธะณะฐั'
            };
            return tips[block] || '';
        }
        if (score >= 0.4) {
            const tips = {
                cognitive: 'โ ะกะพััะธััะนัะต ะฟัะตะดะผะตัั ะฟะพ ัะฒะตัั ะธ ัะพัะผะต, ัะพะฑะธัะฐะนัะต ะฟะฐะทะปั ะธะท 6โ12 ัะฐััะตะน',
                speech:    'โ ะะณัะฐะนัะต ะฒ ยซะฝะฐะทะพะฒะธ ะพะดะฝะธะผ ัะปะพะฒะพะผยป, ะฟะพะดะฑะธัะฐะนัะต ะฐะฝัะพะฝะธะผั (ะฑะพะปััะพะน โ ะผะฐะปะตะฝัะบะธะน)',
                motor:     'โ ะะฐะฝะธะทัะฒะฐะนัะต ะฑััะธะฝั, ะฒััะตะทะฐะนัะต ะฝะพะถะฝะธัะฐะผะธ, ะพะฑะฒะพะดะธัะต ััะฐัะฐัะตัั',
                social:    'โ ะะณัะฐะนัะต ะฒ ัะพะปะตะฒัะต ะธะณัั (ะผะฐะณะฐะทะธะฝ, ะฑะพะปัะฝะธัะฐ), ะฝะฐะทัะฒะฐะนัะต ัะผะพัะธะธ ะฒัะปัั'
            };
            return tips[block] || '';
        }
        const tips = {
            cognitive: 'โ ะกัะธัะฐะนัะต ัััะฟะตะฝัะบะธ ะธ ะปะพะถะบะธ, ัััะพะนัะต ะฑะฐัะฝะธ ะธะท ะบัะฑะธะบะพะฒ ะฟะพ ะพะฑัะฐะทัั',
            speech:    'โ ะงะธัะฐะนัะต ะฒัะปัั 15 ะผะธะฝ/ะดะตะฝั, ะทะฐะดะฐะฒะฐะนัะต ะฒะพะฟัะพัั ยซััะพ ะดะตะปะฐะตั? ะฟะพัะตะผั?ยป',
            motor:     'โ ะะตะฟะธัะต ัะธะณััะบะธ, ัะฒะธัะต ะฑัะผะฐะณั ะฝะฐ ะบััะพัะบะธ, ัะธััะนัะต ะฟะฐะปััะธะบะพะฒัะผะธ ะบัะฐัะบะฐะผะธ',
            social:    'โ ะะฐะทัะฒะฐะนัะต ัะผะพัะธะธ: ยซัั ะทะปะธัััั, ะฟะพัะพะผั ััะพ...ยป, ะฟัะพะธะณััะฒะฐะนัะต ัะธััะฐัะธะธ'
        };
        return tips[block] || '';
    },

    // โโ Reset โโ
    reset() {
        if (!confirm('ะกะฑัะพัะธัั ะฒัะต ัะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั?')) return;
        localStorage.removeItem('testing_profile');
        localStorage.removeItem('testing_results');
        localStorage.removeItem('testing_pron');
        // ะัะธััะบะฐ ะฐัะดะธะพะทะฐะฟะธัะตะน
        try { indexedDB.deleteDatabase('gosha_audio'); } catch(e) {}
        this._profile = null;
        this._results = [];
        showToast('๐๏ธ ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั ัะฑัะพัะตะฝั');
        this.init();
    }
};
